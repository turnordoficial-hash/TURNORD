<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Panel - JBarber</title>
  <link rel="icon" type="image/png" href="jbarber/jjj.png" />
  <link rel="apple-touch-icon" href="jbarber/jjj.png" />
  <link rel="shortcut icon" href="jbarber/jjj.png" type="image/png"/>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <!-- Fuente Premium: Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = { 
      darkMode: 'class', 
      theme: { 
        extend: { 
          fontFamily: { sans: ['Outfit', 'sans-serif'], display: ['Bebas Neue', 'sans-serif'] },
          colors: { 
            barberRed: '#C1121F',
            barberBlue: '#003049',
            dark: { 900: '#09090b', 800: '#18181b', 700: '#27272a' }
          } 
        } 
      } 
    }
  </script>
  <style>
    /* Estilos base */
    body { background-color: #F3F4F6; }
    .dark body { background-color: #000000; background-image: radial-gradient(circle at 50% -20%, #1a1a1a 0%, #000000 100%); background-attachment: fixed; }
    
    .glass-panel { 
        background: rgba(255, 255, 255, 0.7); 
        backdrop-filter: blur(16px); 
        border: 1px solid rgba(255, 255, 255, 0.5);
    }
    .dark .glass-panel { 
        background: rgba(24, 24, 27, 0.6); 
        border: 1px solid rgba(255, 255, 255, 0.05); 
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    /* Animaciones sutiles */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }
    
    /* Animaci√≥n para slots */
    .slot-enter { animation: fadeInScale 0.3s ease-out forwards; opacity: 0; transform: scale(0.95); }
    @keyframes fadeInScale { to { opacity: 1; transform: scale(1); } }

    .slot-selected {
      background-color: #C1121F !important; /* barberRed */
      color: white !important;
      transform: scale(1.05);
      border-color: #C1121F !important;
    }
    /* Toast */
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
    .toast {
        background: white;
        border-left: 4px solid #22c55e;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-top: 10px;
        animation: slideIn 0.3s ease-out forwards;
        display: flex; align-items: center; gap: 12px;
    }
    .dark .toast { background: #18181b; color: white; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>
<body class="text-slate-800 dark:text-slate-200 transition-colors duration-300 font-sans antialiased selection:bg-barberRed selection:text-white relative">

  <!-- Decoraci√≥n de Fondo (Barber√≠a) -->
  <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden opacity-5 dark:opacity-10">
      <!-- Tijeras -->
      <svg class="absolute top-20 -left-10 w-40 h-40 text-gray-500 transform -rotate-12" viewBox="0 0 24 24" fill="currentColor"><path d="M19,3L13,9L15,11L21,5V3M19,5L15,9L17,11L21,7V5M19,7L17,9L19,11L21,9V7M19,9L18,10L19,11L20,10V9M19,11L19,11L19,11L19,11M12,10.5C12,9.67 11.33,9 10.5,9C9.67,9 9,9.67 9,10.5C9,11.33 9.67,12 10.5,12C11.33,12 12,11.33 12,10.5M10.5,7C10.5,7 10.5,7 10.5,7M10.5,14C10.5,14 10.5,14 10.5,14M7.5,10.5C7.5,9.67 6.83,9 6,9C5.17,9 4.5,9.67 4.5,10.5C4.5,11.33 5.17,12 6,12C6.83,12 7.5,11.33 7.5,10.5M6,7C6,7 6,7 6,7M6,14C6,14 6,14 6,14"/></svg>
      <!-- Navaja -->
      <svg class="absolute bottom-20 -right-10 w-40 h-40 text-gray-500 transform rotate-45" viewBox="0 0 24 24" fill="currentColor"><path d="M19,7H16V5H19V7M19,11H16V9H19V11M19,15H16V13H19V15M19,19H16V17H19V19M14,5H11V19H14V5M9,5H6V7H9V5M9,9H6V11H9V9M9,13H6V15H9V13M9,19H6V17H9V19"/></svg>
  </div>

  <!-- Loading Screen -->
  <div id="loading-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-50 dark:bg-black transition-opacity duration-500">
    <div class="flex flex-col items-center">
        <div class="w-16 h-16 border-4 border-barberRed border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500 dark:text-gray-400 font-medium animate-pulse">Cargando experiencia...</p>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="bg-white/70 dark:bg-dark-900/70 backdrop-blur-xl border-b border-gray-200/50 dark:border-white/5 sticky top-0 z-50 transition-colors duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-2">
          <img src="jbarber/jjj.png" alt="Logo" class="w-9 h-9 rounded-xl shadow-lg shadow-red-500/20 object-cover">
          <span class="font-bold text-xl tracking-tight text-gray-900 dark:text-white font-display tracking-wide">JBarber<span class="text-barberRed">.</span></span>
        </div>
        <!-- Profile Dropdown -->
        <div class="relative">
          <div class="flex items-center gap-3 cursor-pointer group z-50" onclick="toggleProfileMenu()">
            <img id="nav-avatar" src="https://ui-avatars.com/api/?name=U&background=C1121F&color=fff" class="w-9 h-9 rounded-full border-2 border-barberRed/50 group-hover:border-barberRed transition-colors object-cover shadow-sm">
            <span id="nav-name" class="hidden sm:block font-medium text-sm text-gray-700 dark:text-gray-200">Cargando...</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 hidden sm:block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
          </div>
          <!-- Dropdown Menu -->
          <div id="profile-menu" class="hidden absolute top-14 right-0 w-64 bg-white dark:bg-dark-800 rounded-2xl shadow-2xl z-50 border border-gray-100 dark:border-white/5 py-2 transform origin-top-right transition-all ring-1 ring-black/5">
            <div class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
                <p class="text-sm font-medium text-gray-900 dark:text-white truncate" id="menu-profile-name">Cargando...</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 truncate" id="menu-profile-phone">...</p>
            </div>
            <div class="py-1">
                <a href="#" onclick="mostrarSeccion('turno')" class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-white/5 text-sm text-gray-700 dark:text-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>Mi Turno</span>
                </a>
                <a href="#" onclick="mostrarSeccion('perfil')" class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-white/5 text-sm text-gray-700 dark:text-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    <span>Mi Perfil</span>
                </a>
            </div>
            <div class="py-1 border-t border-gray-200 dark:border-gray-700">
                <a href="#" onclick="logout()" class="flex items-center gap-3 px-4 py-3 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm text-red-500 dark:text-red-400 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    <span>Cerrar Sesi√≥n</span>
                </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6 relative z-10">
    
    <!-- Banner Marketing -->
    <div id="banner-marketing" class="bg-gradient-to-br from-black via-dark-900 to-barberBlue rounded-3xl p-8 md:p-10 text-white shadow-2xl relative overflow-hidden border border-white/10 group transition-all duration-500">
      <div class="absolute top-0 right-0 -mt-10 -mr-10 w-64 h-64 bg-barberRed rounded-full opacity-20 blur-[80px] group-hover:opacity-30 transition-opacity duration-700"></div>
      <h2 id="banner-title" class="text-4xl font-display font-bold mb-2 tracking-wide">Bienvenido a tu Espacio Premium</h2>
      <p id="banner-text" class="text-gray-400 text-base mb-6 max-w-lg">Gestiona tus citas y turnos con la elegancia y rapidez que mereces. Tu estilo es nuestra prioridad.</p>
      <div class="inline-flex items-center gap-2 bg-white/5 backdrop-blur-md border border-white/10 rounded-full px-4 py-1.5 text-sm text-white font-medium shadow-lg">
        <span class="w-2 h-2 rounded-full bg-barberRed animate-pulse"></span> <span id="banner-badge">Cliente VIP</span>
      </div>
    </div>

    <!-- Micro Dashboard (Estado R√°pido) -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 animate-fade-in mb-8">
      <!-- Card 1: Tu Estado -->
      <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group flex flex-col justify-between min-h-[120px]">
        <div class="absolute right-0 top-0 p-3 opacity-10 text-blue-600 dark:text-blue-400">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider z-10">Tu Estado</p>
        <div id="dash-card-1" class="z-10 mt-2">
           <span class="text-3xl font-black text-gray-900 dark:text-white block">Sin turno</span>
           <span class="text-sm text-gray-500 dark:text-gray-400">--</span>
        </div>
      </div>

      <!-- Card 2: Tiempo Estimado -->
      <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group flex flex-col justify-between min-h-[120px]">
        <div class="absolute right-0 top-0 p-3 opacity-10 text-gold-500">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="currentColor" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider z-10">Tiempo Estimado</p>
        <div id="dash-card-2" class="z-10 mt-2">
           <span class="text-3xl font-black text-gray-900 dark:text-white block">-- min</span>
           <span class="text-sm text-gray-500 dark:text-gray-400">Atenci√≥n aprox: --:--</span>
        </div>
      </div>

      <!-- Card 3: Demanda -->
      <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group flex flex-col justify-between min-h-[120px]">
        <div class="absolute right-0 top-0 p-3 opacity-10 text-green-500">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="currentColor" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider z-10">Demanda Actual</p>
        <div id="dash-card-3" class="z-10 mt-2">
           <span class="inline-flex items-center gap-2 px-3 py-1 rounded-lg bg-gray-100 dark:bg-white/10 text-gray-600 dark:text-gray-300 text-sm font-bold">Calculando...</span>
        </div>
      </div>
    </div>

    <!-- Contacto Directo -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-8 animate-fade-in">
        <a href="https://wa.me/18295877564" target="_blank" class="flex flex-col items-center justify-center p-4 bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-gray-100 dark:border-white/5 hover:bg-green-50 dark:hover:bg-green-900/20 transition-all group hover:-translate-y-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 mb-1" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
            <span class="text-[10px] font-bold text-gray-600 dark:text-gray-400 group-hover:text-green-600">WhatsApp</span>
        </a>
        <a href="tel:+18295877564" class="flex flex-col items-center justify-center p-4 bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-gray-100 dark:border-white/5 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all group hover:-translate-y-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
            <span class="text-[10px] font-bold text-gray-600 dark:text-gray-400 group-hover:text-blue-600">Llamar</span>
        </a>
        <a href="https://maps.google.com/?q=JBarber" target="_blank" class="flex flex-col items-center justify-center p-4 bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-gray-100 dark:border-white/5 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all group hover:-translate-y-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            <span class="text-[10px] font-bold text-gray-600 dark:text-gray-400 group-hover:text-red-600">Ubicaci√≥n</span>
        </a>
        <a href="https://instagram.com/jbarber" target="_blank" class="flex flex-col items-center justify-center p-4 bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-gray-100 dark:border-white/5 hover:bg-pink-50 dark:hover:bg-pink-900/20 transition-all group hover:-translate-y-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-pink-500 mb-1" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
            <span class="text-[10px] font-bold text-gray-600 dark:text-gray-400 group-hover:text-pink-600">Instagram</span>
        </a>
    </div>

    <!-- Panel con Pesta√±as -->
    <div class="animate-fade-in">
      <!-- Botones de Pesta√±as -->
      <div class="mb-8 flex justify-center sm:justify-start border-b border-gray-200 dark:border-white/10">
        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
          <button id="tab-turno-btn" class="whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm transition-all border-barberRed text-barberRed dark:text-barberRed">
            Gesti√≥n de Turnos
          </button>
          <button id="tab-cita-btn" class="whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm transition-all border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600">
            Agendar Cita
          </button>
          <button id="tab-perfil-btn" class="whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm transition-all border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600">
            Mi Cuenta
          </button>
        </nav>
      </div>

      <!-- Contenido de Pesta√±as -->
      <div>
        <!-- Pesta√±a: Mi Turno -->
        <div id="tab-turno-panel">
          <!-- Mi Cita Activa (Nueva Tarjeta) -->
          <div id="card-cita-activa" class="hidden bg-gradient-to-br from-barberBlue to-black p-8 rounded-3xl shadow-xl text-white relative overflow-hidden mb-8 group transition-all duration-500">
            <div class="absolute top-0 right-0 p-4 opacity-20 text-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            </div>
            <h3 class="text-sm font-bold text-blue-100 uppercase tracking-wider mb-2">üìÖ Tu Cita Programada</h3>
            <div class="flex flex-col gap-1">
              <span id="cita-fecha-hora" class="text-4xl font-display font-bold tracking-wide">--</span>
              <span id="cita-barbero" class="text-lg font-medium text-blue-100">--</span>
            </div>
            <p id="cita-servicio" class="text-white/90 mt-3 font-medium">Cita Reservada</p>
            <div class="mt-6 pt-6 border-t border-white/20 flex justify-between items-center">
              <div class="text-sm text-blue-100">Llega 5 min antes</div>
              <button onclick="cancelarCita()" class="text-white/80 hover:text-white text-sm font-semibold transition-colors bg-white/10 px-4 py-2 rounded-lg hover:bg-white/20">Cancelar Cita</button>
            </div>
          </div>

          <!-- Mi Turno Activo -->
          <div id="card-turno-activo" class="hidden bg-white dark:bg-dark-800 p-8 rounded-3xl shadow-xl border border-gray-100 dark:border-white/5 relative overflow-hidden mb-8 group transition-all duration-500">
            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-green-400 to-green-600"></div>
            <div class="absolute top-0 right-0 p-4 opacity-10 text-green-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
            </div>
            <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Tu Turno en Curso</h3>
            <div class="flex items-baseline gap-3">
              <span id="mi-numero-turno" class="text-6xl font-display font-bold text-gray-900 dark:text-white tracking-wide">--</span>
              <span id="mi-estado-turno" class="px-4 py-1.5 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-bold border border-green-200 dark:border-green-800">En Espera</span>
            </div>
            <p id="mi-servicio-turno" class="text-gray-600 dark:text-gray-300 mt-3 font-medium text-lg">Servicio...</p>
            <div class="mt-6 pt-6 border-t border-gray-100 dark:border-white/5 flex justify-between items-center">
              <div id="mi-info-extra" class="text-sm text-gray-500 dark:text-gray-400">Calculando...</div>
              <button onclick="cancelarTurno()" class="text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300 text-sm font-semibold transition-colors">Cancelar Turno</button>
            </div>
          </div>

          <!-- Widget Tomar Turno -->
          <div id="seccion-tomar-turno" class="glass-panel p-8 rounded-3xl shadow-xl">
            <h3 class="text-3xl font-display font-bold mb-8 flex items-center gap-3 text-gray-900 dark:text-white tracking-wide">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-barberRed" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
              Reservar Nuevo Turno
            </h3>
            
            <div id="bloqueado-msg" class="hidden mb-6 bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl text-yellow-800 dark:text-yellow-300 text-sm font-medium border border-yellow-100 dark:border-yellow-800/30 flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
              Ya tienes un turno activo. Cuando finalice, podr√°s tomar otro üëå
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div>
                <label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">Selecciona Servicio</label>
                <select id="select-servicio" class="w-full p-4 rounded-2xl border border-gray-200 dark:border-white/10 bg-white/50 dark:bg-dark-800/50 text-gray-900 dark:text-white focus:ring-2 focus:ring-barberRed focus:border-transparent outline-none transition-all shadow-sm hover:bg-white dark:hover:bg-dark-800">
                  <option value="">Cargando servicios...</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">Selecciona Barbero</label>
                <select id="select-barbero-turno" class="w-full p-4 rounded-2xl border border-gray-200 dark:border-white/10 bg-white/50 dark:bg-dark-800/50 text-gray-900 dark:text-white focus:ring-2 focus:ring-barberRed focus:border-transparent outline-none transition-all shadow-sm hover:bg-white dark:hover:bg-dark-800">
                  <option value="">Cargando barberos...</option>
                </select>
              </div>
              
              <div class="bg-blue-50/80 dark:bg-blue-900/10 p-6 rounded-2xl border border-blue-100 dark:border-blue-500/20 backdrop-blur-sm">
                <p class="text-sm text-blue-800 dark:text-blue-300 font-bold mb-3 uppercase tracking-wide">Estado Actual de la Barber√≠a</p>
                <div class="flex justify-between items-end">
                  <div>
                    <span class="text-5xl font-display font-bold text-blue-600 dark:text-blue-400" id="personas-delante">0</span>
                    <span class="text-sm text-gray-600 dark:text-gray-400 font-medium ml-1">personas delante</span>
                  </div>
                  <div class="text-right">
                    <span class="text-3xl font-display font-bold text-gray-800 dark:text-gray-200" id="tiempo-espera">0 min</span>
                    <span class="text-xs block text-gray-500 dark:text-gray-400 font-medium uppercase mt-1">espera aprox.</span>
                  </div>
                </div>
                <div class="mt-4 pt-4 border-t border-blue-100 dark:border-blue-800/30 flex items-center justify-between">
                  <div class="text-xs font-medium text-gray-600 dark:text-gray-400">Barberos activos: <span id="barberos-activos" class="text-gray-900 dark:text-white font-bold">0</span></div>
                  <span id="estado-barberia-badge" class="text-xs font-bold px-3 py-1 rounded-full bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">Fluida</span>
                </div>
              </div>
            </div>

            <button onclick="tomarTurno()" id="btn-tomar-turno" class="mt-8 w-full bg-black dark:bg-white text-white dark:text-black font-bold py-4 rounded-2xl shadow-xl hover:shadow-2xl hover:scale-[1.01] transition-all flex justify-center items-center gap-3 text-lg border border-gray-800 dark:border-transparent">
              <span>Confirmar Turno</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
            </button>
          </div>
        </div>

        <!-- Pesta√±a: Agendar Cita -->
        <div id="tab-cita-panel" class="hidden">
          <!-- Cita Inteligente -->
          <div id="seccion-cita-inteligente" class="glass-panel p-8 rounded-3xl shadow-xl">
            <h3 class="text-3xl font-display font-bold mb-2 flex items-center gap-2 text-gray-900 dark:text-white tracking-wide">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-barberRed" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
              Agendar cita inteligente
            </h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-6" id="texto-sugerencia">Calculando mejor hora...</p>
            
            <!-- Tarjeta Estado Barber√≠a (Duplicada para esta secci√≥n) -->
            <div class="bg-blue-50/80 dark:bg-blue-900/10 p-6 rounded-2xl border border-blue-100 dark:border-blue-500/20 backdrop-blur-sm mb-6">
                <p class="text-sm text-blue-800 dark:text-blue-300 font-bold mb-3 uppercase tracking-wide">Estado Actual de la Barber√≠a</p>
                <div class="flex justify-between items-end">
                  <div>
                    <span class="text-5xl font-display font-bold text-blue-600 dark:text-blue-400" id="personas-delante-cita">0</span>
                    <span class="text-sm text-gray-600 dark:text-gray-400 font-medium ml-1">personas delante</span>
                  </div>
                  <div class="text-right">
                    <span class="text-3xl font-display font-bold text-gray-800 dark:text-gray-200" id="tiempo-espera-cita">0 min</span>
                    <span class="text-xs block text-gray-500 dark:text-gray-400 font-medium uppercase mt-1">espera aprox.</span>
                  </div>
                </div>
                <div class="mt-4 pt-4 border-t border-blue-100 dark:border-blue-800/30 flex items-center justify-between">
                  <div class="text-xs font-medium text-gray-600 dark:text-gray-400">Barberos activos: <span id="barberos-activos-cita" class="text-gray-900 dark:text-white font-bold">0</span></div>
                  <span id="estado-barberia-badge-cita" class="text-xs font-bold px-3 py-1 rounded-full bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">Fluida</span>
                </div>
            </div>

            <div class="mb-6">
              <label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">Selecciona Barbero</label>
              <select id="select-barbero-cita" class="w-full p-4 rounded-2xl border border-gray-200 dark:border-white/10 bg-white/50 dark:bg-dark-800/50 text-gray-900 dark:text-white focus:ring-2 focus:ring-barberRed focus:border-transparent outline-none transition-all shadow-sm">
                <option value="">Cargando barberos...</option>
              </select>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
              <button id="btn-reservar-sugerida" onclick="reservarCitaInteligente()" class="flex-1 px-6 py-4 bg-gray-900 dark:bg-white text-white dark:text-dark-900 font-bold rounded-2xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">
                Reservar esa hora
              </button>
              <button id="btn-ver-horarios" onclick="verHorariosLibres()" class="flex-1 px-6 py-4 border border-gray-300 dark:border-white/20 text-gray-900 dark:text-white font-bold rounded-2xl hover:bg-gray-50 dark:hover:bg-white/10 transition-all">
                Ver horarios libres
              </button>
              <button id="btn-reservar-mas-tarde" onclick="reservarMasTarde()" class="hidden flex-1 px-6 py-4 bg-barberRed text-white font-bold rounded-2xl shadow hover:scale-[1.02] transition">
                Reservar para m√°s tarde
              </button>
            </div>
            <div id="horarios-libres" class="mt-6 hidden">
              <!-- Pasos Visuales -->
              <div class="flex flex-wrap gap-3 mb-6 text-sm font-semibold">
                <span class="px-3 py-1 rounded-full bg-barberRed text-white shadow-sm">1. Fecha</span>
                <span class="px-3 py-1 rounded-full bg-gray-200 dark:bg-dark-700 text-gray-600 dark:text-gray-300">2. Barbero</span>
                <span class="px-3 py-1 rounded-full bg-gray-200 dark:bg-dark-700 text-gray-600 dark:text-gray-300">3. Hora</span>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">Fecha</label>
                  <input id="date-picker" type="date" class="w-full p-3 rounded-xl border border-gray-200 dark:border-white/10 bg-white/50 dark:bg-dark-800/50 text-gray-900 dark:text-white focus:ring-2 focus:ring-barberRed outline-none transition-all">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">Servicio</label>
                  <select id="select-servicio-cita" class="w-full p-3 rounded-xl border border-gray-200 dark:border-white/10 bg-white/50 dark:bg-dark-800/50 text-gray-900 dark:text-white focus:ring-2 focus:ring-barberRed outline-none transition-all">
                    <option value="">Selecciona un servicio...</option>
                  </select>
                </div>
              </div>
              <div id="rango-horario-display"></div>
              <div class="mt-6 bg-gray-50 dark:bg-dark-800/30 p-6 rounded-2xl border border-gray-100 dark:border-white/5">
                <div id="slots-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
                <div id="action-container" class="mt-6 hidden flex justify-center animate-fade-in">
                    <button id="btn-confirmar-reserva" class="bg-gray-900 dark:bg-white text-white dark:text-dark-900 font-bold py-3 px-8 rounded-xl shadow-lg hover:scale-105 transition-transform flex items-center gap-2">Confirmar Reserva</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pesta√±a: Mi Perfil -->
        <div id="tab-perfil-panel" class="hidden">
          <div class="glass-panel p-8 rounded-3xl shadow-xl max-w-2xl mx-auto">
            <div class="flex flex-col sm:flex-row items-center gap-6">
              <div class="relative flex-shrink-0">
                <img id="profile-avatar" src="https://ui-avatars.com/api/?name=U" class="w-32 h-32 rounded-full border-4 border-white dark:border-dark-800 shadow-2xl object-cover ring-2 ring-barberRed">
                <button onclick="document.getElementById('avatar-upload').click()" class="absolute bottom-0 right-0 bg-barberRed text-white p-2.5 rounded-full hover:bg-red-700 shadow-lg border-4 border-white dark:border-dark-900 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="subirAvatar(this)">
              </div>
              <div class="text-center sm:text-left">
                <h3 id="profile-name" class="text-4xl font-display font-bold text-gray-900 dark:text-white tracking-wide">Cargando...</h3>
                <p id="profile-phone" class="text-gray-500 dark:text-gray-400 text-lg mt-1">...</p>
                <span class="inline-block mt-2 px-4 py-1 rounded-full bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-400 text-xs font-bold border border-red-200 dark:border-red-800/30">
                  Cliente frecuente ‚≠ê
                </span>
              </div>
            </div>

            <form id="form-perfil" class="mt-10 space-y-6">
              <div>
                <label class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 block">Nombre Completo</label>
                <input type="text" id="edit-nombre" class="w-full p-4 rounded-2xl border border-gray-200 dark:border-white/10 bg-white/50 dark:bg-dark-800/50 text-gray-900 dark:text-white focus:ring-2 focus:ring-barberRed focus:border-transparent outline-none transition-all">
              </div>
              <div>
                <label class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 block">Correo Electr√≥nico</label>
                <input type="email" id="edit-email" class="w-full p-4 rounded-2xl border border-gray-200 dark:border-white/10 bg-white/50 dark:bg-dark-800/50 text-gray-900 dark:text-white focus:ring-2 focus:ring-barberRed focus:border-transparent outline-none transition-all">
              </div>
              <button type="submit" class="w-full bg-gray-900 dark:bg-white hover:bg-gray-800 dark:hover:bg-gray-100 text-white dark:text-dark-900 font-bold py-4 rounded-2xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 flex justify-center items-center gap-2 mt-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                <span>Actualizar Datos</span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Zona Premium -->
    <section class="mt-12 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 animate-fade-in">
      <div class="p-6 rounded-2xl bg-white dark:bg-dark-800 border border-gray-100 dark:border-white/5">
        <h3 class="font-display text-xl text-gray-900 dark:text-white mb-2">Consejos de Barber√≠a</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">Mant√©n tu corte perfecto con lavados cada 2‚Äì3 d√≠as y peinado en seco.</p>
      </div>
      <div class="p-6 rounded-2xl bg-white dark:bg-dark-800 border border-gray-100 dark:border-white/5">
        <h3 class="font-display text-xl text-gray-900 dark:text-white mb-2">Tips de Cuidado</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">Usa aceite para barba y cepillo suave para evitar irritaciones.</p>
      </div>
      <div class="p-6 rounded-2xl bg-white dark:bg-dark-800 border border-gray-100 dark:border-white/5">
        <h3 class="font-display text-xl text-gray-900 dark:text-white mb-2">Estilos en Tendencia</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">Fade medio con textura, barba perfilada y acabado mate.</p>
      </div>
      <div class="p-6 rounded-2xl bg-white dark:bg-dark-800 border border-gray-100 dark:border-white/5">
        <h3 class="font-display text-xl text-gray-900 dark:text-white mb-2">Ofertas VIP</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">Suscr√≠bete para recibir descuentos exclusivos y recordatorios inteligentes.</p>
      </div>
    </section>
  </main>

  <script>
    // Variables globales
    const negocioId = 'barberia005';
  </script>

  <script type="module">
    import { supabase } from './database.js';
    const clienteId = localStorage.getItem(`cliente_id_${negocioId}`);
    let serviciosCache = {};
    let configCache = null;
    let diasOperacionNum = [];
    function animateNumber(el, to, duration = 500) {
      if (!el) return;
      const from = parseInt(el.textContent || '0', 10) || 0;
      const start = performance.now();
      const step = (now) => {
        const p = Math.min(1, (now - start) / duration);
        const val = Math.round(from + (to - from) * p);
        el.textContent = String(val);
        if (p < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }
    
    // Contenido Rotativo del Banner
    const bannerContent = [
        { title: "‚úÇÔ∏è Consejo del d√≠a", text: "No te laves el cabello justo despu√©s del corte. Espera al menos 24 horas para que el estilo se asiente.", badge: "Tip Pro" },
        { title: "ü§Ø ¬øSab√≠as que...?", text: "El cabello crece en promedio 1.25 cm al mes. ¬°Mant√©n tu corte fresco cada 3 semanas!", badge: "Curiosidad" },
        { title: "üíà Servicio Premium", text: "Prueba nuestro tratamiento de toalla caliente. Relajaci√≥n total para tu piel.", badge: "Recomendado" },
        { title: "üåô Dato Curioso", text: "La barba crece m√°s r√°pido de noche debido a la relajaci√≥n del cuerpo.", badge: "Sab√≠as que" },
        { title: "üî• Promoci√≥n", text: "Trae a un amigo y obt√©n un 10% de descuento en tu pr√≥ximo corte.", badge: "Oferta" },
        { title: "üßî Cuidado de Barba", text: "Usa aceite para barba diariamente para evitar la picaz√≥n y mantenerla suave.", badge: "Tip Barba" },
        { title: "üöø Agua Fr√≠a", text: "Enjuagar tu cabello con agua fr√≠a al final del ba√±o ayuda a cerrar las cut√≠culas y dar brillo.", badge: "Tip Salud" }
    ];

    function updateBanner() {
        const idx = Math.floor(Math.random() * bannerContent.length);
        const content = bannerContent[idx];
        document.getElementById('banner-title').textContent = content.title;
        document.getElementById('banner-text').textContent = content.text;
        document.getElementById('banner-badge').textContent = content.badge;
    }
    
    // Clave p√∫blica VAPID (Debe coincidir con la de backend)
    const VAPID_PUBLIC_KEY = 'BCMJiXkuO_Q_y_JAMO56tAaJw1JVmSOejavwLsLC9OWCBihIxlGuHpgga6qEyuPQ2cF_KLuotZS7YzdUEzAiHlQ';

    // Toast Helper
    function showToast(message, type = 'success') {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
        }
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><span class="font-medium text-gray-800 dark:text-white">${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(100%)'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // Verificar sesi√≥n
    if (!clienteId) {
      window.location.href = 'login_cliente.html';
    }

    // UI Helpers
    window.toggleProfileMenu = () => {
        document.getElementById('profile-menu').classList.toggle('hidden');
    }
    window.logout = async () => {
      localStorage.removeItem(`cliente_id_${negocioId}`);
      localStorage.removeItem(`cliente_telefono_${negocioId}`);
      await supabase.auth.signOut();
      window.location.href = 'login_cliente.html';
    };

    // Cerrar dropdown si se hace clic afuera
    window.addEventListener('click', function(e) {
        const profileMenuContainer = document.querySelector('.relative');
        const profileMenu = document.getElementById('profile-menu');
        if (profileMenu && !profileMenu.classList.contains('hidden') && !profileMenuContainer.contains(e.target)) {
            profileMenu.classList.add('hidden');
        }
    });

    // L√≥gica de Pesta√±as
    const turnoBtn = document.getElementById('tab-turno-btn');
    const citaBtn = document.getElementById('tab-cita-btn');
    const perfilBtn = document.getElementById('tab-perfil-btn');
    const turnoPanel = document.getElementById('tab-turno-panel');
    const citaPanel = document.getElementById('tab-cita-panel');
    const perfilPanel = document.getElementById('tab-perfil-panel');
    const activeClasses = 'border-barberRed text-barberRed dark:text-barberRed';
    const inactiveClasses = 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600';

    const switchTab = (tab) => {
        turnoPanel.classList.toggle('hidden', tab !== 'turno');
        citaPanel.classList.toggle('hidden', tab !== 'cita');
        perfilPanel.classList.toggle('hidden', tab !== 'perfil');
        
        turnoBtn.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${tab === 'turno' ? activeClasses : inactiveClasses}`;
        citaBtn.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${tab === 'cita' ? activeClasses : inactiveClasses}`;
        perfilBtn.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all ${tab === 'perfil' ? activeClasses : inactiveClasses}`;
    };

    turnoBtn.addEventListener('click', () => switchTab('turno'));
    citaBtn.addEventListener('click', () => switchTab('cita'));
    perfilBtn.addEventListener('click', () => switchTab('perfil'));
    window.mostrarSeccion = (seccion) => {
        switchTab(seccion);
        document.getElementById('profile-menu').classList.add('hidden');
    };

    // Cargar Datos Iniciales
    async function init() {
      updateBanner(); // Actualizar banner al inicio
      await cargarPerfil();
      await cargarServicios();
      await actualizarEstadoFila();
      await verificarTurnoActivo();
      await verificarCitaActiva(); // Verificar citas
      
      // Listeners Reactivos para Citas
      document.getElementById('date-picker')?.addEventListener('change', renderSlotsForSelectedDate);
      document.getElementById('select-servicio-cita')?.addEventListener('change', renderSlotsForSelectedDate);
      document.getElementById('btn-confirmar-reserva')?.addEventListener('click', confirmarReservaManual);
      
      // Suscripci√≥n Realtime
      supabase.channel('cliente-updates')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'turnos', filter: `negocio_id=eq.${negocioId}` }, 
          () => {
            actualizarEstadoFila();
            verificarTurnoActivo();
            verificarCitaActiva();
          })
        .subscribe();

      // Inicializar Push Notifications
      registrarServiceWorker();

      // Ocultar loader
      const loader = document.getElementById('loading-screen');
      if(loader) {
          loader.classList.add('opacity-0', 'pointer-events-none');
          setTimeout(() => loader.remove(), 500);
      }
    }
    
    // --- L√≥gica Push Notifications ---
    function registrarServiceWorker() {
      if ('serviceWorker' in navigator) {
        const swPath = location.pathname.replace(/[^/]*$/, '') + 'sw.js';
        navigator.serviceWorker.register(swPath).then(async registration => {
            console.log('SW registrado');
            // Solicitar permiso si no se tiene
            if (Notification.permission === 'default') {
                await solicitarPermisoNotificacion();
            }
        }).catch(err => console.error('SW error:', err));
      }
    }

    async function solicitarPermisoNotificacion() {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });
            await guardarSuscripcion(subscription);
        }
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
    }

    async function guardarSuscripcion(subscription) {
        const telefono = localStorage.getItem(`cliente_telefono_${negocioId}`);
        if(telefono) await supabase.from('push_subscriptions').upsert({ user_id: telefono, subscription, negocio_id: negocioId }, { onConflict: 'user_id, negocio_id' });
    }

    // --- L√ìGICA DE TIEMPO REAL (CORE) ---
    function calcularTiempoEsperaReal(turnosEnEspera, turnosEnAtencion, activeBarbers) {
        const barberos = Math.max(1, activeBarbers);
        
        // REGLA 1: Si hay huecos libres (menos gente atendiendo que barberos) y nadie esperando
        if (turnosEnAtencion.length < barberos && turnosEnEspera.length === 0) {
            return 0;
        }

        let tiempoTotalMinutos = 0;

        // 1. Sumar lo que falta de los que est√°n en atenci√≥n (REGLA 2)
        turnosEnAtencion.forEach(t => {
            const duracion = t.duracion || serviciosCache[t.servicio] || 30; // Usar duraci√≥n guardada si existe
            const inicio = t.started_at ? new Date(t.started_at) : new Date();
            const transcurrido = (Date.now() - inicio.getTime()) / 60000;
            const restante = Math.max(0, duracion - transcurrido);
            tiempoTotalMinutos += restante;
        });

        // 2. Sumar duraci√≥n completa de los que est√°n en espera (REGLA 3)
        turnosEnEspera.forEach(t => {
            const duracion = t.duracion || serviciosCache[t.servicio] || 30;
            tiempoTotalMinutos += duracion;
        });

        // 3. Promediar entre barberos activos
        return Math.round(tiempoTotalMinutos / barberos);
    }

    async function cargarPerfil() {
      const { data, error } = await supabase.from('clientes').select('*').eq('id', clienteId).single();
      if (error) {
        console.error('Error cargando perfil:', error);
        if (error.code === 'PGRST116') { // Not found
            logout();
        }
        return;
      }
      if (data) {
        // Navbar y Men√∫
        document.getElementById('nav-name').textContent = data.nombre.split(' ')[0];
        document.getElementById('menu-profile-name').textContent = data.nombre;
        document.getElementById('menu-profile-phone').textContent = data.telefono;
        
        // Pesta√±a de Perfil
        document.getElementById('profile-name').textContent = data.nombre;
        document.getElementById('profile-phone').textContent = data.telefono;
        document.getElementById('edit-nombre').value = data.nombre;
        document.getElementById('edit-email').value = data.email || '';
        
        const avatarUrl = data.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nombre)}&background=C1121F&color=fff&bold=true`;
        document.getElementById('nav-avatar').src = avatarUrl;
        document.getElementById('profile-avatar').src = avatarUrl;
      }
    }

    async function cargarServicios() {
      const { data } = await supabase.from('servicios').select('*').eq('negocio_id', negocioId).eq('activo', true);
      const select = document.getElementById('select-servicio');
      select.innerHTML = '<option value="">Selecciona un servicio...</option>';
      if (data) {
        data.forEach(s => {
          serviciosCache[s.nombre] = s.duracion_min;
          const option = document.createElement('option');
          option.value = s.nombre;
          option.textContent = `${s.nombre}`;
          select.appendChild(option);
        });
      }
      const svcCita = document.getElementById('select-servicio-cita');
      if (svcCita) {
        svcCita.innerHTML = '<option value="">Selecciona un servicio...</option>';
        (data || []).forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.nombre;
          opt.textContent = s.nombre;
          svcCita.appendChild(opt);
        });
      }
    }

    async function cargarConfigNegocio() {
      const { data } = await supabase
        .from('configuracion_negocio')
        .select('*')
        .eq('negocio_id', negocioId)
        .order('updated_at', { ascending: false })
        .limit(1)
        .maybeSingle();
      configCache = data || null;
      
      let diasOp = data?.dias_operacion || [];
      if (typeof diasOp === 'string') {
          try { diasOp = JSON.parse(diasOp); } catch (e) { diasOp = []; }
      }
      
      const map = { 'Domingo':0, 'Lunes':1, 'Martes':2, 'Mi√©rcoles':3, 'Jueves':4, 'Viernes':5, 'S√°bado':6 };
      diasOperacionNum = diasOp.map(n => map[n]).filter(v => typeof v === 'number');
    }

    async function actualizarEstadoFila() {
      const hoy = new Date().toISOString().slice(0, 10);
      
      // Obtener TODOS los turnos activos con sus detalles para c√°lculo preciso
      const { data: turnosActivos } = await supabase.from('turnos')
            .select('id, estado, servicio, started_at, created_at, duracion')
            .eq('negocio_id', negocioId)
            .eq('fecha', hoy)
            .in('estado', ['En espera', 'En atenci√≥n']);
      
      const enEspera = (turnosActivos || []).filter(t => t.estado === 'En espera');
      const enAtencion = (turnosActivos || []).filter(t => t.estado === 'En atenci√≥n');

      // Barberos activos
      const { count: barberosCount } = await supabase.from('barberos')
        .select('*', { count: 'exact', head: true })
        .eq('negocio_id', negocioId)
        .eq('activo', true);
      const activeBarbers = barberosCount || 1;

      // Actualizar UI Barberos
      const ba = document.getElementById('barberos-activos');
      if(ba) ba.textContent = activeBarbers;
      const baCita = document.getElementById('barberos-activos-cita');
      if(baCita) baCita.textContent = activeBarbers;

      // Personas delante (En espera)
      const personasEnCola = enEspera.length;
      
      const pd = document.getElementById('personas-delante');
      if(pd) animateNumber(pd, personasEnCola);
      const pdCita = document.getElementById('personas-delante-cita');
      if(pdCita) animateNumber(pdCita, personasEnCola);
      
      // Calcular Tiempo Estimado (L√≥gica Nueva)
      const tiempoEstimado = calcularTiempoEsperaReal(enEspera, enAtencion, activeBarbers);
      
      let tiempoTexto = "";
      let estado = 'Fluida';
      let badgeClass = 'bg-green-100 text-green-700';
      let demandaTexto = "üü¢ Baja";

      if (tiempoEstimado <= 0) {
          tiempoTexto = "Atenci√≥n inmediata";
          estado = 'Libre';
      } else {
          tiempoTexto = `${tiempoEstimado} min`;
          if (tiempoEstimado > 20) { 
              estado = 'Media'; 
              badgeClass = 'bg-yellow-100 text-yellow-700'; 
              demandaTexto = "üü° Media";
          }
          if (tiempoEstimado > 45) { 
              estado = 'Alta'; 
              badgeClass = 'bg-red-100 text-red-700'; 
              demandaTexto = "üî¥ Alta";
          }
      }
      
      const te = document.getElementById('tiempo-espera');
      if(te) te.textContent = tiempoTexto;
      const teCita = document.getElementById('tiempo-espera-cita');
      if(teCita) teCita.textContent = tiempoTexto;

      const badge = document.getElementById('estado-barberia-badge'); 
      if(badge) {
          badge.textContent = estado;
          badge.className = `text-xs font-bold px-2 py-1 rounded ${badgeClass}`;
      }

      // --- ACTUALIZAR NUEVAS TARJETAS (DASHBOARD) ---
      // Card 1: Tu Estado (Default si no hay turno)
      const dashCard1 = document.getElementById('dash-card-1');
      if(dashCard1 && !window.hasActiveTurn && !window.hasActiveAppointment) {
          dashCard1.innerHTML = `
             <span class="text-4xl font-display font-bold text-gray-900 dark:text-white block">${personasEnCola}</span>
             <span class="text-sm text-gray-500 dark:text-gray-400">Personas en espera</span>
          `;
      }

      // Card 2: Tiempo Estimado
      const dashCard2 = document.getElementById('dash-card-2');
      if(dashCard2 && !window.hasActiveTurn && !window.hasActiveAppointment) {
          const horaAprox = new Date(Date.now() + tiempoEstimado * 60000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          dashCard2.innerHTML = `
             <span class="text-4xl font-display font-bold text-gray-900 dark:text-white block">${tiempoTexto}</span>
             <span class="text-sm text-gray-500 dark:text-gray-400">Atenci√≥n aprox: ${horaAprox}</span>
          `;
      }

      // Card 3: Demanda
      const dashCard3 = document.getElementById('dash-card-3');
      if(dashCard3) {
          dashCard3.innerHTML = `
             <span class="inline-flex items-center gap-2 px-3 py-1 rounded-lg ${badgeClass} dark:bg-opacity-20 text-sm font-bold">
                ${demandaTexto}
             </span>
          `;
      }

      const badgeCita = document.getElementById('estado-barberia-badge-cita');
      if(badgeCita) {
          badgeCita.textContent = estado;
          badgeCita.className = `text-xs font-bold px-2 py-1 rounded ${badgeClass}`;
      }

      // Sugerencia de cita inteligente
      const textoSug = document.getElementById('texto-sugerencia');
      const btnSug = document.getElementById('btn-reservar-sugerida');
      const btnMasTarde = document.getElementById('btn-reservar-mas-tarde');
      const ahora = new Date();
      const sugerida = sugerirHora(ahora, tiempoEstimado, 30, estado);
      const fmt = sugerida.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
      if (estado === 'Alta') {
        textoSug.textContent = `Alta demanda ahora mismo. Te recomendamos reservar para m√°s tarde (ej: ${fmt}).`;
        btnSug.classList.add('hidden');
        btnMasTarde.classList.remove('hidden');
      } else {
        textoSug.textContent = `Seg√∫n la fila actual, tu mejor hora es: ${fmt}`;
        btnSug.classList.remove('hidden');
        btnMasTarde.classList.add('hidden');
      }
      window.__sugeridaHora__ = sugerida;
      window.__duracionServicio__ = 30; // Default
    }

    async function verificarTurnoActivo() {
      const hoy = new Date().toISOString().slice(0, 10);
      const telefono = localStorage.getItem(`cliente_telefono_${negocioId}`);
      
      const { data } = await supabase.from('turnos')
        .select('*')
        .eq('negocio_id', negocioId)
        .eq('fecha', hoy)
        .in('estado', ['En espera', 'En atenci√≥n'])
        .eq('telefono', telefono) // Usamos tel√©fono como link por ahora
        .maybeSingle();

      const card = document.getElementById('card-turno-activo');
      const form = document.getElementById('seccion-tomar-turno');

      if (data) {
        window.hasActiveTurn = true;
        card.classList.remove('hidden');
        form.classList.add('opacity-50', 'pointer-events-none'); // Deshabilitar tomar otro
        document.getElementById('mi-numero-turno').textContent = data.turno;
        document.getElementById('mi-servicio-turno').textContent = data.servicio;
        document.getElementById('bloqueado-msg').classList.remove('hidden');
        
        const estadoEl = document.getElementById('mi-estado-turno');
        const infoExtra = document.getElementById('mi-info-extra');

        // --- ACTUALIZAR DASHBOARD CON DATOS DEL TURNO ---
        const dashCard1 = document.getElementById('dash-card-1');
        if(dashCard1) {
            dashCard1.innerHTML = `
               <span class="text-4xl font-display font-bold text-barberRed block">${data.turno}</span>
               <span class="text-sm text-gray-500 dark:text-gray-400 font-bold">TU TURNO ACTUAL</span>
            `;
        }

        if (data.estado === 'En atenci√≥n') {
            estadoEl.textContent = "En Atenci√≥n";
            estadoEl.className = "px-4 py-1.5 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-xs font-bold border border-blue-200 dark:border-blue-800 animate-pulse";
            
            // Contexto emocional
            document.querySelector('#card-turno-activo h3').textContent = "‚úÇÔ∏è Te est√°n atendiendo";
            infoExtra.innerHTML = `<span class="text-lg font-medium text-gray-800 dark:text-white">Rel√°jate y disfruta üòå</span>`;
            
            const dashCard2 = document.getElementById('dash-card-2');
            if(dashCard2) {
                dashCard2.innerHTML = `
                   <span class="text-3xl font-display font-bold text-barberBlue dark:text-blue-400 block">AHORA</span>
                   <span class="text-sm text-gray-500 dark:text-gray-400">Te est√°n atendiendo</span>
                `;
            }

        } else {
            estadoEl.textContent = "En Espera";
            estadoEl.className = "px-4 py-1.5 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 text-xs font-bold border border-yellow-200 dark:border-yellow-800";
            document.querySelector('#card-turno-activo h3').textContent = "üïí Tu turno est√° en cola";

            // Calcular espera espec√≠fica para este usuario
            const { data: allTurns } = await supabase.from('turnos')
                .select('id, estado, servicio, started_at, created_at')
                .eq('negocio_id', negocioId)
                .eq('fecha', hoy)
                .in('estado', ['En espera', 'En atenci√≥n']);
            
            const enAtencion = allTurns.filter(t => t.estado === 'En atenci√≥n');
            const enEsperaAntes = allTurns.filter(t => t.estado === 'En espera' && t.created_at < data.created_at);
            
            const { count: barberosCount } = await supabase.from('barberos').select('*', { count: 'exact', head: true }).eq('negocio_id', negocioId).eq('activo', true);
            const activeBarbers = barberosCount || 1;

            const personasDelante = enEsperaAntes.length;
            const tiempoEstimado = calcularTiempoEsperaReal(enEsperaAntes, enAtencion, activeBarbers);
            
            let mensajeTiempo = "";
            if (personasDelante === 0 && enAtencion.length < activeBarbers) {
                 mensajeTiempo = "¬°Es casi tu turno! Prep√°rate.";
            } else {
                 mensajeTiempo = `‚è≥ Tiempo estimado: ~${tiempoEstimado} min`;
            }

            const dashCard2 = document.getElementById('dash-card-2');
            if(dashCard2) {
                const horaAprox = new Date(Date.now() + tiempoEstimado * 60000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                dashCard2.innerHTML = `
                   <span class="text-4xl font-display font-bold text-gray-900 dark:text-white block">${tiempoEstimado} min</span>
                   <span class="text-sm text-gray-500 dark:text-gray-400">Atenci√≥n aprox: ${horaAprox}</span>
                `;
            }

            infoExtra.innerHTML = `
                <div class="flex flex-col">
                    <span class="font-bold text-lg text-gray-900 dark:text-white">${personasDelante} personas delante</span>
                    <span class="text-sm text-gray-500 dark:text-gray-400">${mensajeTiempo}</span>
                </div>
            `;

            // Notificaci√≥n inteligente
            if (personasDelante <= 1 && !window.notificacionCercaEnviada) {
               sendPushNotification('üîî ¬°Ya casi!', `Solo queda ${personasDelante} persona delante. Ac√©rcate al local.`);
               window.notificacionCercaEnviada = true;
            }
        }

      } else {
        window.hasActiveTurn = false;
        card.classList.add('hidden');
        form.classList.remove('opacity-50', 'pointer-events-none');
        document.getElementById('bloqueado-msg').classList.add('hidden');
      }
    }

    // --- L√ìGICA DE CITAS (NUEVA) ---
    async function verificarCitaActiva() {
        const telefono = localStorage.getItem(`cliente_telefono_${negocioId}`);
        if (!telefono) return;

        const nowISO = new Date().toISOString();
        const { data: cita } = await supabase
            .from('citas')
            .select('*, barberos(nombre)')
            .eq('negocio_id', negocioId)
            .eq('cliente_telefono', telefono)
            .neq('estado', 'Cancelada')
            .gte('start_at', nowISO)
            .order('start_at', { ascending: true })
            .limit(1)
            .maybeSingle();

        const cardCita = document.getElementById('card-cita-activa');
        const seccionTurno = document.getElementById('seccion-tomar-turno');
        
        if (cita) {
            window.hasActiveAppointment = true;
            cardCita.classList.remove('hidden');
            seccionTurno.classList.add('hidden'); // Ocultar tomar turno si hay cita
            
            const date = new Date(cita.start_at);
            const today = new Date();
            const isToday = date.toDateString() === today.toDateString();
            const dateStr = isToday ? 'Hoy' : date.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
            const timeStr = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('cita-fecha-hora').textContent = `${dateStr} ‚Äì ${timeStr}`;
            
            let barberName = "Barbero asignado";
            if (cita.barberos) {
                 barberName = cita.barberos.nombre;
            } else if (cita.barber_id) {
                 const { data: b } = await supabase.from('barberos').select('nombre').eq('id', cita.barber_id).single();
                 if(b) barberName = b.nombre;
            }
            document.getElementById('cita-barbero').textContent = `Barbero: ${barberName}`;
            cardCita.dataset.id = cita.id;

            // Update Dashboard
            const dashCard1 = document.getElementById('dash-card-1');
            if(dashCard1) {
                 dashCard1.innerHTML = `
                   <span class="text-4xl font-display font-bold text-barberBlue dark:text-blue-400 block">CITA</span>
                   <span class="text-sm text-gray-500 dark:text-gray-400 font-bold">PROGRAMADA</span>
                `;
            }
            const dashCard2 = document.getElementById('dash-card-2');
            if(dashCard2) {
                 dashCard2.innerHTML = `
                   <span class="text-3xl font-display font-bold text-gray-900 dark:text-white block">${timeStr}</span>
                   <span class="text-sm text-gray-500 dark:text-gray-400">Hora de atenci√≥n</span>
                `;
            }

        } else {
            window.hasActiveAppointment = false;
            cardCita.classList.add('hidden');
            // Solo mostrar tomar turno si no hay turno activo tampoco
            if (!window.hasActiveTurn) {
                 seccionTurno.classList.remove('hidden');
            }
        }
    }

    // Helper para notificaciones push
    async function sendPushNotification(title, body) {
      const telefono = document.getElementById('profile-phone').textContent;
      if (!telefono || telefono === '...') return;
      
      try {
        await supabase.functions.invoke('send-push-notification', {
          body: {
            telefono: telefono,
            negocio_id: negocioId,
            title: title,
            body: body
          }
        });
      } catch (e) {
        console.error('Error enviando push:', e);
      }
    }

    // Acciones
    window.tomarTurno = async () => {
      // Solicitar permiso de notificaci√≥n al interactuar (Mejor pr√°ctica UX)
      if (Notification.permission === 'default') await solicitarPermisoNotificacion();

      const servicio = document.getElementById('select-servicio').value;
      if (!servicio) return alert('Selecciona un servicio');
      const barberSel = document.getElementById('select-barbero-turno').value;
      if (!barberSel) return alert('Selecciona un barbero');

      const nombre = document.getElementById('profile-name').textContent;
      const telefono = document.getElementById('profile-phone').textContent;
      const hoy = new Date().toISOString().slice(0, 10);
      const hora = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

      // Generar ID Turno (L√≥gica simplificada cliente, idealmente backend function)
      // Obtenemos letra del d√≠a
      const fechaBase = new Date('2024-08-23');
      const diff = Math.floor((new Date() - fechaBase) / (86400000));
      const letra = String.fromCharCode(65 + ((diff % 26) + 26) % 26);
      
      // Obtener ultimo turno
      const { data: last } = await supabase.from('turnos')
        .select('turno').eq('negocio_id', negocioId).eq('fecha', hoy)
        .like('turno', `${letra}%`).order('created_at', { ascending: false }).limit(1);
      
      let num = 1;
      if (last && last.length > 0) {
        num = parseInt(last[0].turno.substring(1)) + 1;
      }
      const nuevoTurno = `${letra}${String(num).padStart(2, '0')}`;

      // Insertar
      const btn = document.querySelector('button[onclick="tomarTurno()"]');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="flex items-center gap-2"><svg class="animate-spin h-4 w-4 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Reservando...</span>';
      }

      try {
        const { error } = await supabase.from('turnos').insert([{
          negocio_id: negocioId,
          turno: nuevoTurno,
          nombre, telefono, servicio,
          estado: 'En espera',
          fecha: hoy,
          hora: hora,
          barber_id: Number(barberSel)
        }]);

        if (error) throw error;

        showToast(`¬°Turno ${nuevoTurno} reservado!`);
        
        // Enviar notificaci√≥n
        await sendPushNotification('üéâ ¬°Est√°s en la lista!', `Tu turno ${nuevoTurno} est√° confirmado. Rel√°jate, nosotros te avisamos.`);
        
        if (navigator.vibrate) navigator.vibrate(200);
        window.scrollTo({ top: 0, behavior: 'smooth' });
        verificarTurnoActivo();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'Confirmar Turno';
        }
      }
    };

    // Utilidades de cita inteligente
    function roundToSlot(date, slotMin = 30) {
      const d = new Date(date);
      const mins = d.getMinutes();
      const rounded = Math.ceil(mins / slotMin) * slotMin;
      d.setMinutes(rounded, 0, 0);
      return d;
    }
    function sugerirHora(ahora, tiempoEstimado, duracion, estado) {
      let base = new Date(ahora);
      if (estado === 'Alta') {
        base.setMinutes(base.getMinutes() + Math.max(tiempoEstimado, 120));
      } else {
        base.setMinutes(base.getMinutes() + Math.max(tiempoEstimado, duracion));
      }
      return roundToSlot(base, 30);
    }

    async function cargarBarberos() {
      const { data } = await supabase.from('barberos').select('id,nombre,usuario').eq('negocio_id', negocioId).eq('activo', true).order('nombre', { ascending: true });
      const select = document.getElementById('select-barbero-cita');
      select.innerHTML = '<option value="">Selecciona un barbero...</option>';
      (data || []).forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = b.nombre || b.usuario;
        select.appendChild(opt);
      });
      const selectTurno = document.getElementById('select-barbero-turno');
      if (selectTurno) {
        selectTurno.innerHTML = '<option value="">Selecciona un barbero...</option>';
        (data || []).forEach(b => {
          const opt = document.createElement('option');
          opt.value = b.id;
          opt.textContent = b.nombre || b.usuario;
          selectTurno.appendChild(opt);
        });
      }
    }

    window.reservarCitaInteligente = async () => {
      const telefono = document.getElementById('profile-phone').textContent;
      const start = window.__sugeridaHora__;
      const end = new Date(start); 
      end.setMinutes(end.getMinutes() + (window.__duracionServicio__ || 30));
      const barberSel = document.getElementById('select-barbero-cita').value;
      const barberId = barberSel ? Number(barberSel) : null;
      const btn = document.querySelector('button[onclick="reservarCitaInteligente()"]');

      if (!barberId) { 
        showToast('No hay barberos seleccionados', 'error'); 
        return; 
      }

      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="flex items-center gap-2"><svg class="animate-spin h-4 w-4 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Reservando Cita...</span>';
      }

      try {
        const { data, error } = await supabase.rpc('programar_cita', {
          p_negocio_id: negocioId,
          p_barber_id: barberId,
          p_cliente_telefono: telefono,
          p_start: start.toISOString(),
          p_end: end.toISOString()
        });

        if (error) throw error;

        showToast('¬°Cita inteligente reservada!');
        await sendPushNotification('¬°Cita Reservada!', `Tu cita inteligente para hoy a las ${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} ha sido confirmada.`);
        
        // Cerrar modal o redirigir
        setTimeout(() => window.location.reload(), 2000);
      } catch (e) {
        showToast('No se pudo reservar la cita: ' + e.message, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'Agendar Cita Inteligente';
        }
      }
    };

    window.reservarMasTarde = async () => {
      const ahora = new Date();
      const duracion = window.__duracionServicio__ || 30;
      const sugerida = sugerirHora(ahora, 120, duracion, 'Alta');
      window.__sugeridaHora__ = sugerida;
      document.getElementById('texto-sugerencia').textContent =
        `Te recomendamos reservar para m√°s tarde: ${sugerida.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}`;
    };

    window.verHorariosLibres = () => {
      document.getElementById('horarios-libres').classList.remove('hidden');
      const today = new Date();
      // Ajustar zona horaria local para el input date
      const offset = today.getTimezoneOffset();
      const localDate = new Date(today.getTime() - (offset*60*1000));
      const d = localDate.toISOString().slice(0,10);
      const dp = document.getElementById('date-picker');
      if (!dp.value) dp.value = d;
      renderSlotsForSelectedDate();
    };

    // Funci√≥n auxiliar para verificar disponibilidad
    function slotDisponible(slotStart, duracion, citas = [], breaks = []) {
        const slotEnd = new Date(slotStart);
        slotEnd.setMinutes(slotEnd.getMinutes() + duracion);
        const startMs = slotStart.getTime();
        const endMs = slotEnd.getTime();

        // Verificar choques con citas
        const conflictCita = citas.some(c => {
            const cStart = new Date(c.start_at).getTime();
            const cEnd = new Date(c.end_at).getTime();
            return startMs < cEnd && endMs > cStart;
        });
        if (conflictCita) return false;

        // Verificar choques con breaks
        const conflictBreak = breaks.some(b => {
            const [bStart, bEnd] = b;
            return startMs < bEnd && endMs > bStart;
        });
        if (conflictBreak) return false;

        return true;
    }

    async function renderSlotsForSelectedDate() {
      await cargarConfigNegocio();
      const dateStr = document.getElementById('date-picker').value;
      const barberSel = document.getElementById('select-barbero-cita').value;
      const servicioSel = document.getElementById('select-servicio-cita').value || document.getElementById('select-servicio').value;
      
      const slotsContainer = document.getElementById('slots-container');
      const rangoDisplay = document.getElementById('rango-horario-display');
      const actionContainer = document.getElementById('action-container');
      
      // Resetear selecci√≥n
      window.__horaSeleccionada__ = null;
      if(actionContainer) actionContainer.classList.add('hidden');

      if (!dateStr || !barberSel || !servicioSel) {
          if(slotsContainer) slotsContainer.innerHTML = '';
          if(rangoDisplay) rangoDisplay.textContent = '';
          return;
      }
      
      slotsContainer.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8 animate-pulse">Buscando disponibilidad...</div>';
      
      const dur = serviciosCache[servicioSel] || 30;
      
      // Configuraci√≥n de horario
      const apStr = configCache?.hora_apertura || '08:00';
      const ciStr = configCache?.hora_cierre || '21:00';
      const ap = apStr.split(':').map(Number);
      const ci = ciStr.split(':').map(Number);

      if (rangoDisplay) {
          rangoDisplay.textContent = `Horario disponible: ${apStr} - ${ciStr}`;
          rangoDisplay.className = "mt-4 text-center text-sm font-medium text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-white/5 py-2 rounded-lg border border-gray-200 dark:border-white/10";
      }
      
      // Verificar d√≠a de operaci√≥n (Usando fecha local para evitar errores de zona horaria)
      const startDay = new Date(dateStr + 'T00:00:00');
      const dayNum = startDay.getDay(); // 0=Domingo
      
      if (diasOperacionNum.length && !diasOperacionNum.includes(dayNum)) {
          slotsContainer.innerHTML = '<div class="col-span-full flex flex-col items-center justify-center text-gray-500 py-8"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>El negocio no opera este d√≠a.</span></div>';
          return;
      }

      startDay.setHours(ap[0], ap[1], 0, 0);
      
      const endDay = new Date(dateStr + 'T00:00:00');
      endDay.setHours(ci[0], ci[1], 0, 0);
      
      // VALIDACI√ìN: Verificar si el cliente ya tiene cita este d√≠a
      const telefono = document.getElementById('profile-phone').textContent;
      if (telefono && telefono !== '...') {
          const { data: misCitas } = await supabase
              .from('citas')
              .select('id')
              .eq('negocio_id', negocioId)
              .eq('cliente_telefono', telefono)
              .neq('estado', 'Cancelada')
              .eq('fecha', dateStr); // ‚úÖ Validaci√≥n robusta por fecha exacta

          if (misCitas && misCitas.length > 0) {
              slotsContainer.innerHTML = `
                  <div class="col-span-full flex flex-col items-center justify-center p-6 bg-amber-50 dark:bg-amber-900/10 rounded-2xl border border-amber-100 dark:border-amber-800/30">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-amber-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                      <h3 class="text-lg font-bold text-amber-800 dark:text-amber-400 mb-1">Ya tienes una cita</h3>
                      <p class="text-sm text-amber-700 dark:text-amber-300 text-center">Solo se permite una reserva por d√≠a.</p>
                  </div>
              `;
              return;
          }
      }

      // Obtener citas existentes
      const { data: citas } = await supabase
          .from('citas')
          .select('start_at, end_at')
          .eq('negocio_id', negocioId)
          .eq('barber_id', Number(barberSel))
          .neq('estado', 'Cancelada')
          .gte('start_at', startDay.toISOString())
          .lte('start_at', endDay.toISOString());

      // Obtener breaks
      const { data: estado } = await supabase.from('estado_negocio').select('weekly_breaks').eq('negocio_id', negocioId).maybeSingle();
      const wb = estado?.weekly_breaks || [];
      const brk = wb.find(x => x.day === dayNum);
      const breaks = [];
      if (brk && brk.start && brk.end) {
        const bs = new Date(dateStr + 'T00:00:00'); const be = new Date(dateStr + 'T00:00:00');
        const s = brk.start.split(':').map(Number); const e = brk.end.split(':').map(Number);
        bs.setHours(s[0], s[1], 0, 0); be.setHours(e[0], e[1], 0, 0);
        breaks.push([bs.getTime(), be.getTime()]);
      }
      
      // Obtener turnos activos (En atenci√≥n) para bloquear slots
      const { data: turnosActivos } = await supabase
          .from('turnos')
          .select('started_at, hora, servicio')
          .eq('negocio_id', negocioId)
          .eq('barber_id', Number(barberSel))
          .eq('estado', 'En atenci√≥n')
          .eq('fecha', dateStr);

      (turnosActivos || []).forEach(t => {
          const s = t.started_at ? new Date(t.started_at) : new Date(`${dateStr}T${t.hora}`);
          const d = serviciosCache[t.servicio] || 30;
          const e = new Date(s);
          e.setMinutes(e.getMinutes() + d);
          breaks.push([s.getTime(), e.getTime()]);
      });

      // Generar slots cada 30 min (est√°ndar)
      const step = 30; 
      const tmp = new Date(startDay);
      const now = new Date();
      
      // ‚úÖ Fix Correcto para slots pasados
      const nowLocalStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
      const isToday = dateStr === nowLocalStr;
      
      slotsContainer.innerHTML = '';

      while (tmp < endDay) {
        const currentSlot = new Date(tmp);
        
        // Validar si el slot est√° en el pasado (si es hoy)
        let isPast = false;
        if (isToday && currentSlot.getTime() < now.getTime()) isPast = true;

        // Validar que el servicio cabe antes del cierre
        const slotEnd = new Date(currentSlot);
        slotEnd.setMinutes(slotEnd.getMinutes() + dur);
        if (slotEnd > endDay) break;

        // Validar disponibilidad usando la duraci√≥n del servicio
        const disponible = !isPast && slotDisponible(currentSlot, dur, citas || [], breaks);

        const btn = document.createElement('button');
        const baseClass = "slot-enter py-3 rounded-xl font-bold text-sm border transition-all duration-200 relative overflow-hidden flex flex-col items-center justify-center";
        
        if (disponible) {
            btn.className = `${baseClass} bg-white dark:bg-dark-800 border-gray-200 dark:border-white/10 hover:bg-barberRed hover:text-white hover:border-barberRed dark:hover:border-barberRed shadow-sm cursor-pointer group`;
            btn.onclick = () => seleccionarHora(currentSlot, btn);
        } else {
            btn.className = `${baseClass} bg-gray-50 dark:bg-dark-900/50 border-transparent text-gray-300 dark:text-gray-600 cursor-not-allowed opacity-60`;
            btn.disabled = true;
        }
        
        const timeStr = currentSlot.toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit'});
        
        btn.innerHTML = `
            <span class="${disponible ? 'text-gray-900 dark:text-white group-hover:text-white' : ''}">${timeStr}</span>
            ${disponible ? `<span class="text-[10px] text-green-600 dark:text-green-400 font-medium mt-1">Libre</span>` : `<span class="text-[10px] mt-1">Ocupado</span>`}
        `;

        slotsContainer.appendChild(btn);
        tmp.setMinutes(tmp.getMinutes() + step); // Avanzar 30 min
      }
      
      if (slotsContainer.children.length === 0) {
           slotsContainer.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">No hay horarios disponibles.</div>';
      }
    }

    function seleccionarHora(date, btnElement) {
        window.__horaSeleccionada__ = date;
        
        // Resetear estilos
        const container = document.getElementById('slots-container');
        Array.from(container.children).forEach(c => {
            if (!c.disabled) {
                c.classList.remove('slot-selected');
                c.classList.add('bg-white', 'dark:bg-dark-800'); // Restore default bg
            }
        });

        // Aplicar estilo seleccionado
        btnElement.classList.remove('bg-white', 'dark:bg-dark-800');
        btnElement.classList.add('slot-selected');
        
        // Mostrar bot√≥n confirmar
        const actionContainer = document.getElementById('action-container');
        actionContainer.classList.remove('hidden');
        
        // Scroll suave hacia el bot√≥n
        actionContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    async function confirmarReservaManual() {
        // Solicitar permiso de notificaci√≥n al interactuar
        if (Notification.permission === 'default') {
            await solicitarPermisoNotificacion();
        }

        if (!window.__horaSeleccionada__) return;
        
        const date = window.__horaSeleccionada__;
        const barberSel = document.getElementById('select-barbero-cita').value;
        const servicioSel = document.getElementById('select-servicio-cita').value || document.getElementById('select-servicio').value;
        const telefono = document.getElementById('profile-phone').textContent;
        const dur = serviciosCache[servicioSel] || 30;
        
        const slotEnd = new Date(date);
        slotEnd.setMinutes(slotEnd.getMinutes() + dur);
        
        const timeStr = date.toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit'});
        
        // ‚úÖ Modal Pro en lugar de confirm()
        confirmarAccion(
            'Confirmar Cita',
            `¬øReservar para las ${timeStr}?\nServicio: ${servicioSel} (${dur} min)`,
            async () => {
            try {
                const { error } = await supabase.rpc('programar_cita', {
                    p_negocio_id: negocioId,
                    p_barber_id: Number(barberSel),
                    p_cliente_telefono: telefono,
                    p_start: date.toISOString(),
                    p_end: slotEnd.toISOString()
                });
                
                if (error) throw error;
                
                showToast('¬°Cita reservada con √©xito!');
                
                // Enviar notificaci√≥n
                sendPushNotification('¬°Cita Confirmada!', `Tu cita para las ${timeStr} ha sido agendada.`);

                // Limpiar selecci√≥n
                window.__horaSeleccionada__ = null;
                document.getElementById('action-container').classList.add('hidden');
                renderSlotsForSelectedDate(); // Recargar slots
                
            } catch (e) {
                alert('Ese horario acaba de ocuparse o hubo un error. Por favor selecciona otro.');
                renderSlotsForSelectedDate();
            }
        });
    }

    window.cancelarTurno = async () => {
      confirmarAccion('Cancelar Turno', '¬øEst√°s seguro de que deseas cancelar tu turno actual?', async () => {
          const telefono = document.getElementById('profile-phone').textContent;
          const hoy = new Date().toISOString().slice(0, 10);
          
          const { error } = await supabase.from('turnos')
            .update({ estado: 'Cancelado' })
            .eq('negocio_id', negocioId)
            .eq('fecha', hoy)
            .eq('telefono', telefono)
            .in('estado', ['En espera']);
            
          if(error) showToast('Error al cancelar', 'error');
          else {
              showToast('Turno cancelado');
              verificarTurnoActivo();
          }
      });
    };

    window.cancelarCita = async () => {
        const card = document.getElementById('card-cita-activa');
        const id = card.dataset.id;
        if(!id) return;
        
        confirmarAccion('Cancelar Cita', '¬øEst√°s seguro de que deseas cancelar tu cita programada?', async () => {
            const { error } = await supabase.from('citas').update({ estado: 'Cancelada' }).eq('id', id);
            if(error) showToast('Error al cancelar cita', 'error');
            else { showToast('Cita cancelada'); verificarCitaActiva(); }
        });
    };

    // Actualizar Perfil
    document.getElementById('form-perfil').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nombre = document.getElementById('edit-nombre').value;
      const email = document.getElementById('edit-email').value;

      const { error } = await supabase.from('clientes')
        .update({ nombre, email })
        .eq('id', clienteId);

      if (error) alert('Error al actualizar');
      else {
        alert('Perfil actualizado');
        cargarPerfil();
      }
    });

    // Subir Avatar (Mejorado con Fallback Robusto)
    window.subirAvatar = async (input) => {
      const file = input.files[0];
      if (!file) return;

      const bucketName = 'avatars';
      const fileName = `public/${clienteId}-${Date.now()}`;
      
      try {
        // Intentar subir al bucket
        const { error: uploadError } = await supabase.storage
          .from(bucketName)
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true 
          });

        if (uploadError) throw uploadError;

        const { data: { publicUrl } } = supabase.storage
          .from(bucketName)
          .getPublicUrl(fileName);

        if (!publicUrl) throw new Error('No se pudo obtener la URL p√∫blica.');

        // Actualizar BD con URL del bucket
        const { error: dbError } = await supabase.from('clientes')
          .update({ avatar_url: publicUrl })
          .eq('id', clienteId);
        
        if (dbError) throw dbError;
        
        alert('Avatar actualizado con √©xito.');
        await cargarPerfil();

      } catch (error) {
        console.warn('Fallo subida a Storage, intentando fallback Base64:', error);
        
        // FALLBACK: Guardar Base64 directamente en la BD
        // Esto maneja casos donde el bucket no existe, no hay permisos, o cuota excedida.
        try {
            const reader = new FileReader();
            reader.onload = async (e) => {
              const dataUrl = e.target.result;
              
              // Intentar guardar en la columna avatar_url
              const { error: dbError } = await supabase.from('clientes')
                .update({ avatar_url: dataUrl })
                .eq('id', clienteId);
                
              if (dbError) {
                console.error('Error guardando Base64:', dbError);
                alert('No se pudo guardar la imagen. Contacta al administrador.');
                return;
              }
              
              // Actualizar UI inmediatamente
              document.getElementById('nav-avatar').src = dataUrl;
              document.getElementById('profile-avatar').src = dataUrl;
              alert('Avatar guardado correctamente (modo local).');
            };
            reader.readAsDataURL(file);
            
        } catch (e2) {
            console.error('Error fatal al procesar imagen:', e2);
            alert('No se pudo procesar la imagen.');
        }
      }
    };

    init();
    cargarBarberos();
    cargarConfigNegocio();
    document.querySelectorAll('a[href^="https://wa.me/"]').forEach(a=>a.addEventListener('click',()=>{ if(navigator.vibrate) navigator.vibrate(20) }));
  </script>
</body>
</html>
