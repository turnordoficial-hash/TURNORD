<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acceso Clientes - Jbarber</title>
  <meta name="description" content="Inicia sesión en JBarber para gestionar tus turnos y citas.">
  
  <!-- Open Graph para compartir la App -->
  <meta property="og:title" content="JBarber App">
  <meta property="og:description" content="Accede a tu perfil y toma tu turno ahora.">
  <meta property="og:image" content="jbarber/jjj.png">
  
  <link rel="icon" type="image/png" href="jbarber/jjj.png" />
  <link rel="apple-touch-icon" href="jbarber/jjj.png" />
  <link rel="shortcut icon" href="jbarber/jjj.png" type="image/png"/>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#C1121F">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = { 
      darkMode: 'class', 
      theme: { 
        extend: { 
          colors: { 
            barberBlack: '#0B0B0B',
            barberRed: '#C1121F',
            amber: { 450: '#F59E0B' } 
          } 
        } 
      } 
    }
  </script>
  <style>
    body { 
        font-family: 'Outfit', sans-serif;
        background: radial-gradient(circle at 20% 20%, rgba(193,18,31,0.05), transparent 40%),
                    #F8F8F9;
    }
    .dark body {
        background: radial-gradient(circle at 80% 80%, rgba(193,18,31,0.08), transparent 40%),
                    #0B0B0C;
    }
    .font-display { font-family: 'Bebas Neue', sans-serif; }
    
    @keyframes barberpole {
      from { background-position: 0 0; }
      to { background-position: 40px 40px; }
    }
    .barber-stripes {
      background-image: linear-gradient(45deg, 
        #C1121F 25%, 
        #ffffff 25%, 
        #ffffff 50%, 
        #003049 50%, 
        #003049 75%, 
        #ffffff 75%, 
        #ffffff 100%
      );
      background-size: 40px 40px;
      animation: barberpole 3s linear infinite;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .dark .barber-stripes {
        background-image: linear-gradient(45deg, 
        #C1121F 25%, 
        #18181b 25%, 
        #18181b 50%, 
        #003049 50%, 
        #003049 75%, 
        #18181b 75%, 
        #18181b 100%
      );
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-up { animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%,60% { transform: translateX(-5px); }
      40%,80% { transform: translateX(5px); }
    }
    
    @keyframes modalIn {
        from { opacity: 0; transform: scale(0.95) translateY(10px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .animate-modal { animation: modalIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <div id="modalIOS" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[60] px-4 transition-all duration-300">
    <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-sm p-6 relative shadow-2xl border border-gray-200 dark:border-zinc-800 animate-modal text-center">
      <button onclick="document.getElementById('modalIOS').classList.add('hidden'); document.getElementById('modalIOS').classList.remove('flex')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 text-2xl">&times;</button>
      <div class="mb-4 flex justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
      </div>
      <h3 class="text-xl font-bold mb-2 text-gray-900 dark:text-white">Instalar en iPhone/iPad</h3>
      <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">1. Toca el botón <span class="font-bold">Compartir</span> <svg class="inline w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg> abajo.<br>2. Selecciona <span class="font-bold">"Agregar a Inicio"</span>.</p>
      <button onclick="document.getElementById('modalIOS').classList.add('hidden'); document.getElementById('modalIOS').classList.remove('flex')" class="bg-gray-900 dark:bg-white text-white dark:text-black font-bold py-3 px-8 rounded-xl w-full">Entendido</button>
    </div>
  </div>

  <div class="w-full max-w-md bg-white/90 dark:bg-[#111113]/90 backdrop-blur-sm rounded-3xl border border-black/5 dark:border-white/10 shadow-[0_20px_60px_rgba(0,0,0,0.12)] hover:shadow-[0_25px_70px_rgba(0,0,0,0.18)] transition-all duration-500 overflow-hidden relative animate-fade-up">
    <!-- Barber Stripe Header -->
    <div class="h-3 w-full barber-stripes"></div>
    
    <div class="p-8 md:p-10">
        <!-- Logo Section -->
        <div class="flex flex-col items-center mb-10">
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-barberRed to-blue-600 rounded-full blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                <div class="relative w-32 h-32 bg-white dark:bg-black rounded-full p-1 shadow-xl flex items-center justify-center border border-gray-100 dark:border-zinc-800">
                    <img src="jbarber/jjj.png" alt="JBarber" class="w-full h-full object-cover rounded-full">
                </div>
            </div>
            <h1 class="mt-6 text-5xl font-display text-gray-900 dark:text-white tracking-wide">JBARBER<span class="text-barberRed">.</span></h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 font-medium tracking-[0.2em] uppercase mt-1">Estilo & Precisión</p>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-6">
            <div class="space-y-1">
                <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider ml-1">Usuario</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </div>
                    <input type="text" id="usuario_login" required placeholder="Cédula o código" autocomplete="username"
                        class="w-full p-3 border rounded-xl bg-gray-50 dark:bg-zinc-800/50 border-gray-200 dark:border-zinc-700 text-gray-900 dark:text-white focus:border-barberRed focus:ring-2 focus:ring-barberRed/30 outline-none transition-all duration-300 pl-11 pr-4">
                </div>
            </div>

            <div class="space-y-1">
                <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider ml-1">Contraseña</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    </div>
                    <input type="password" id="password_login" required placeholder="••••••••" autocomplete="current-password"
                        class="w-full p-3 border rounded-xl bg-gray-50 dark:bg-zinc-800/50 border-gray-200 dark:border-zinc-700 text-gray-900 dark:text-white focus:border-barberRed focus:ring-2 focus:ring-barberRed/30 outline-none transition-all duration-300 pl-11 pr-12">
                    <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        <svg id="eyeOffIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a10.05 10.05 0 015.393-6.125M17.55 4.45a10.052 10.052 0 012.093 7.55M1 1l22 22" /></svg>
                    </button>
                </div>
            </div>

            <button type="submit" id="btnSubmit" class="w-full bg-black dark:bg-white text-white dark:text-black font-semibold py-4 rounded-xl transition-all duration-300 hover:scale-[1.02] hover:shadow-[0_10px_25px_rgba(0,0,0,0.15)] dark:hover:shadow-[0_10px_30px_rgba(255,255,255,0.15)] active:scale-[0.98] flex items-center justify-center gap-3 group">
                <span id="btnText">INICIAR SESIÓN</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
            </button>
        </form>

        <p id="loginError" class="hidden text-sm text-red-600 dark:text-red-400 text-center font-medium mt-3"></p>

        <div class="mt-8 pt-6 border-t border-gray-100 dark:border-zinc-800 text-center">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">¿Eres nuevo en JBarber?</p>
            <button onclick="abrirModalRegistro()" class="text-barberRed font-bold hover:text-red-700 transition-colors text-sm tracking-wide border border-barberRed/20 px-6 py-2 rounded-full hover:bg-barberRed/5">
                CREAR CUENTA
            </button>
        </div>
    </div>
  </div>

  <button id="btn-install-pwa" class="hidden fixed bottom-6 right-6 z-50 bg-barberRed text-white px-4 py-3 rounded-full shadow-2xl hover:scale-105 hover:shadow-[0_10px_30px_rgba(193,18,31,0.4)] transition-all font-bold flex items-center gap-2 animate-bounce-in">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
    </svg>
    Instalar App
  </button>

  <div id="modalRegistro" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 px-4 transition-all duration-300">
    <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-lg p-8 relative shadow-[0_10px_40px_rgba(0,0,0,0.18)] border border-gray-200 dark:border-zinc-800 animate-modal max-h-[90vh] overflow-y-auto">
      <button onclick="cerrarModalRegistro()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 text-2xl">&times;</button>
      
      <h2 class="text-2xl font-bold mb-2 text-gray-900 dark:text-white">Crea tu perfil en segundos</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Guarda tus datos y evita filas innecesarias.</p>

      <form id="formRegistro" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1 dark:text-gray-300">Nombre Completo</label>
            <input type="text" id="reg_nombre" required class="w-full p-3 border rounded-xl bg-gray-50 dark:bg-zinc-800/50 border-gray-200 dark:border-zinc-700 text-gray-900 dark:text-white focus:border-barberRed focus:ring-2 focus:ring-barberRed/30 outline-none transition-all duration-300">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 dark:text-gray-300">Teléfono</label>
            <input type="tel" id="reg_telefono" required pattern="[0-9]{8,15}" class="w-full p-3 border rounded-xl bg-gray-50 dark:bg-zinc-800/50 border-gray-200 dark:border-zinc-700 text-gray-900 dark:text-white focus:border-barberRed focus:ring-2 focus:ring-barberRed/30 outline-none transition-all duration-300">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1 dark:text-gray-300">Correo Electrónico</label>
          <input type="email" id="reg_email" required class="w-full p-3 border rounded-xl bg-gray-50 dark:bg-zinc-800/50 border-gray-200 dark:border-zinc-700 text-gray-900 dark:text-white focus:border-barberRed focus:ring-2 focus:ring-barberRed/30 outline-none transition-all duration-300">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1 dark:text-gray-300">Contraseña</label>
          <input type="password" id="reg_password" required minlength="4" class="w-full p-3 border rounded-xl bg-gray-50 dark:bg-zinc-800/50 border-gray-200 dark:border-zinc-700 text-gray-900 dark:text-white focus:border-barberRed focus:ring-2 focus:ring-barberRed/30 outline-none transition-all duration-300">
        </div>
        <button type="submit" id="btnRegSubmit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-blue-600/20">
          <span id="btnRegText">Crear Cuenta</span>
        </button>
      </form>
    </div>
  </div>

  <script type="module">
    import { ensureSupabase } from './database.js';
    const negocioId = 'barberia005';

    // 1. Capturar código de referido de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref');
    if (refCode) {
        localStorage.setItem(`referral_code_${negocioId}`, refCode);
    }

    // Lógica PWA para Login
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    let deferredPrompt;
    const installBtn = document.getElementById('btn-install-pwa');
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.classList.remove('hidden');
    });

    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if(outcome === 'accepted') installBtn.classList.add('hidden');
        deferredPrompt = null;
      }
    });

    // Funciones Modal
    const modal = document.getElementById('modalRegistro');
    window.abrirModalRegistro = () => {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.animation = 'neonPulse 1.5s ease-in-out';
    };
    window.cerrarModalRegistro = () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.animation = '';
    };

    // Show/Hide Password
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password_login');
    const eyeIcon = document.getElementById('eyeIcon');
    const eyeOffIcon = document.getElementById('eyeOffIcon');
    const loginErrorEl = document.getElementById('loginError');

    if (togglePassword) {
      togglePassword.addEventListener('click', () => {
          const isPassword = passwordInput.type === 'password';
          passwordInput.type = isPassword ? 'text' : 'password';
          eyeIcon.classList.toggle('hidden', isPassword);
          eyeOffIcon.classList.toggle('hidden', !isPassword);
      });
    }

    // Reset error animation
    if (loginErrorEl) {
      loginErrorEl.addEventListener('animationend', () => loginErrorEl.classList.remove('animate-[shake_0.4s]'));
    }

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const usuarioInput = document.getElementById('usuario_login').value.trim();
      const pass = document.getElementById('password_login').value.trim();
      const btn = document.getElementById('btnSubmit');
      const btnText = document.getElementById('btnText');
      const errorMsg = document.getElementById('loginError');
  
      btn.disabled = true;
      btn.classList.add('opacity-70', 'cursor-not-allowed');
      btnText.textContent = 'Verificando...';
      if (errorMsg) {
        errorMsg.classList.add('hidden');
        errorMsg.textContent = '';
      }
  
      try {
        const client = await ensureSupabase();
  
        let emailToLogin = usuarioInput;
        let perfilData = null;

        // Si NO es un email, intentamos buscar el perfil por documento
        if (!usuarioInput.includes('@')) {
            // Usamos una función RPC segura (SECURITY DEFINER) para obtener el email sin exponer datos.
            const { data: rpcData, error: rpcError } = await client.rpc('get_email_by_document', {
                p_documento_identidad: usuarioInput,
                p_negocio_id: negocioId
            });

            if (rpcError) throw rpcError;
            if (!rpcData) throw new Error('Usuario no encontrado. Verifique su cédula o código.');
            
            emailToLogin = rpcData;
        } else {
            emailToLogin = usuarioInput;
        }

        // 2. Iniciar sesión con el email (ya sea ingresado o encontrado)
        const { data: signInData, error: signInError } = await client.auth.signInWithPassword({
          email: emailToLogin,
          password: pass
        });
  
        if (signInError) throw signInError;
        if (!signInData || !signInData.user) throw new Error('Credenciales incorrectas.');
  
        // 3. Buscar el perfil usando el ID de usuario autenticado (Más robusto)
        // Esto asegura que obtenemos los datos correctos incluso si entramos por email directo
        const { data: perfilAuth, error: errAuth } = await client
            .from('clientes')
            .select('id, nombre, telefono, avatar_url')
            .eq('id', signInData.user.id) // Usar ID de auth
            .maybeSingle();
        
        // Si encontramos perfil por ID, lo usamos. Si no, usamos el que teníamos (si había)
        const perfilFinal = perfilAuth || perfilData;

        if (perfilFinal) {
            localStorage.setItem(`cliente_id_${negocioId}`, perfilFinal.id);
            localStorage.setItem(`cliente_nombre_${negocioId}`, perfilFinal.nombre);
            localStorage.setItem(`cliente_telefono_${negocioId}`, perfilFinal.telefono);
            localStorage.setItem(`cliente_avatar_${negocioId}`, perfilFinal.avatar_url || '');
        } else {
            // Fallback: Si no hay perfil en tabla clientes, guardamos al menos el ID de auth
            localStorage.setItem(`cliente_id_${negocioId}`, signInData.user.id);
            // CORRECCIÓN: Guardar metadata para evitar pantalla blanca en panel
            if (signInData.user.user_metadata) {
                 if (signInData.user.user_metadata.nombre) localStorage.setItem(`cliente_nombre_${negocioId}`, signInData.user.user_metadata.nombre);
                 if (signInData.user.user_metadata.telefono) localStorage.setItem(`cliente_telefono_${negocioId}`, signInData.user.user_metadata.telefono);
            }
        }
  
        window.location.href = 'panel_cliente.html';
  
      } catch (error) {
        console.error('Error Login:', error);
        if (errorMsg) {
          if (error.message.includes('Invalid login credentials') || error.message.includes('invalid_grant')) {
            errorMsg.textContent = 'Credenciales incorrectas. Verifica tu usuario y contraseña.';
          } else if (error.message.includes('Email not confirmed')) {
            errorMsg.textContent = 'Correo no confirmado. Revisa tu bandeja de entrada.';
          } else if (error.status === 429 || error.message.includes('rate limit') || error.message.includes('Too Many Requests')) {
            errorMsg.textContent = 'Demasiados intentos. Espera un momento (60s) antes de intentar.';
          } else {
            errorMsg.textContent = error.message || 'Error al iniciar sesión';
          }
          errorMsg.classList.remove('hidden');
          errorMsg.classList.add('animate-[shake_0.4s]');
        }
        btn.disabled = false;
        btn.classList.remove('opacity-70', 'cursor-not-allowed');
        btnText.textContent = 'INICIAR SESIÓN';
      }
    });

    // Registro
    document.getElementById('formRegistro').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nombre = document.getElementById('reg_nombre').value.trim();
      const telefono = document.getElementById('reg_telefono').value.trim();
      const email = document.getElementById('reg_email').value.trim();
      const pass = document.getElementById('reg_password').value.trim();
      
      // Validación de formato de teléfono (Solo números, 8-15 dígitos)
      if (!/^\d{8,15}$/.test(telefono)) {
        alert('El teléfono debe contener solo números (8 a 15 dígitos).');
        return;
      }

      const btn = document.getElementById('btnRegSubmit');
      const btnText = document.getElementById('btnRegText');

      const referidoPor = localStorage.getItem(`referral_code_${negocioId}`);

      btn.disabled = true;
      btnText.textContent = 'Creando cuenta...';

      try {
        const client = await ensureSupabase();

        // 2. Crear el usuario en Supabase Auth enviando datos al Trigger
        const { data: { user }, error: authError } = await client.auth.signUp({
          email,
          password: pass,
          options: {
            data: {
              nombre: nombre,
              telefono: telefono,
              negocio_id: negocioId,
              referido_por: referidoPor || null // Enviamos el ID del que refirió
            }
          }
        });

        if (authError) throw authError;
        if (!user) throw new Error('No se pudo crear el usuario.');

        // El perfil en 'clientes' se crea automáticamente por el Trigger en la base de datos.

        alert('¡Cuenta creada con éxito! Revisa tu correo para confirmar y luego inicia sesión.');
        window.cerrarModalRegistro();
        document.getElementById('usuario_login').value = email;
        document.getElementById('password_login').value = pass;

      } catch (error) {
        console.error('Error Registro:', error);
        if (error.message && error.message.includes('email rate limit')) {
            alert('Has solicitado demasiados correos de verificación. Por favor, revisa tu bandeja de entrada o espera 15 minutos antes de intentar de nuevo.');
        } else if (error.status === 429 || error.message.includes('rate limit') || error.message.includes('Too Many Requests')) {
            alert('Demasiados intentos. Por seguridad, espera un momento.');
        } else {
            alert(error.message || 'Error al registrarse');
        }
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Crear Cuenta';
      }
    });

    const readyOverlay = document.getElementById('readyOverlay');
    if (readyOverlay) {
      readyOverlay.classList.remove('hidden');
      readyOverlay.classList.add('flex');
      setTimeout(() => {
        readyOverlay.classList.add('hidden');
        readyOverlay.classList.remove('flex');
      }, 2500);
    }
  </script>
  <div id="readyOverlay" class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm items-center justify-center p-6">
    <div class="w-full max-w-sm bg-white/10 border border-white/20 rounded-2xl p-8 text-center shadow-2xl">
      <img src="jbarber/jjj.png" alt="JBarber" class="w-16 h-16 rounded-lg mx-auto mb-4 shadow-lg shadow-red-500/30 object-cover">
      <h3 class="text-white font-extrabold text-2xl tracking-tight">Listo, ya puedes tomar turno</h3>
      <p class="text-white/80 text-sm mt-2">Bienvenido a JBarber.</p>
      <div class="mt-4 flex items-center justify-center gap-2 text-white/80">
        <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle>
          <path d="M4 12a8 8 0 018-8" stroke-width="4" class="opacity-75"></path>
        </svg>
        <span class="text-sm">Cargando…</span>
      </div>
    </div>
  </div>
</body>
</html>
