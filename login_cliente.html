<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acceso Clientes - TurnoRD</title>
  <meta name="description" content="Inicia sesión en JBarber para gestionar tus turnos y citas.">
  
  <!-- Open Graph para compartir la App -->
  <meta property="og:title" content="JBarber App">
  <meta property="og:description" content="Accede a tu perfil y toma tu turno ahora.">
  <meta property="og:image" content="jbarber/jjj.png">
  
  <link rel="icon" type="image/png" href="jbarber/jjj.png" />
  <link rel="apple-touch-icon" href="jbarber/jjj.png" />
  <link rel="shortcut icon" href="jbarber/jjj.png" type="image/png"/>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#C1121F">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = { 
      darkMode: 'class', 
      theme: { 
        extend: { 
          colors: { 
            barberBlack: '#0B0B0B',
            barberRed: '#C1121F',
            amber: { 450: '#F59E0B' } 
          } 
        } 
      } 
    }
  </script>
  <style>
    body { 
        font-family: 'Outfit', sans-serif;
        background-color: #F9FAFB;
        background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
        background-size: 32px 32px;
    }
    .dark body {
        background-color: #09090b;
        background-image: radial-gradient(#1f2937 1px, transparent 1px);
    }
    .font-display { font-family: 'Bebas Neue', sans-serif; }
    
    @keyframes barberpole {
      from { background-position: 0 0; }
      to { background-position: 40px 40px; }
    }
    .barber-stripes {
      background-image: linear-gradient(45deg, 
        #C1121F 25%, 
        #ffffff 25%, 
        #ffffff 50%, 
        #003049 50%, 
        #003049 75%, 
        #ffffff 75%, 
        #ffffff 100%
      );
      background-size: 40px 40px;
      animation: barberpole 3s linear infinite;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .dark .barber-stripes {
        background-image: linear-gradient(45deg, 
        #C1121F 25%, 
        #18181b 25%, 
        #18181b 50%, 
        #003049 50%, 
        #003049 75%, 
        #18181b 75%, 
        #18181b 100%
      );
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-up { animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    
    @keyframes modalIn {
        from { opacity: 0; transform: scale(0.95) translateY(10px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .animate-modal { animation: modalIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
  </style>
  <!-- Modal Instrucciones iOS -->
  <div id="modalIOS" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[60] px-4 transition-all duration-300">
    <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-sm p-6 relative shadow-2xl border border-gray-200 dark:border-zinc-800 animate-modal text-center">
      <button onclick="document.getElementById('modalIOS').classList.add('hidden'); document.getElementById('modalIOS').classList.remove('flex')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 text-2xl">&times;</button>
      <div class="mb-4 flex justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
      </div>
      <h3 class="text-xl font-bold mb-2 text-gray-900 dark:text-white">Instalar en iPhone/iPad</h3>
      <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">1. Toca el botón <span class="font-bold">Compartir</span> <svg class="inline w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg> abajo.<br>2. Selecciona <span class="font-bold">"Agregar a Inicio"</span>.</p>
      <button onclick="document.getElementById('modalIOS').classList.add('hidden'); document.getElementById('modalIOS').classList.remove('flex')" class="bg-gray-900 dark:bg-white text-white dark:text-black font-bold py-3 px-8 rounded-xl w-full">Entendido</button>
    </div>
  </div>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-md bg-white dark:bg-zinc-900 rounded-3xl shadow-2xl overflow-hidden relative animate-fade-up">
    <!-- Barber Stripe Header -->
    <div class="h-3 w-full barber-stripes"></div>
    
    <div class="p-8 md:p-10">
        <!-- Logo Section -->
        <div class="flex flex-col items-center mb-10">
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-barberRed to-blue-600 rounded-full blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                <div class="relative w-32 h-32 bg-white dark:bg-black rounded-full p-1 shadow-xl flex items-center justify-center border border-gray-100 dark:border-zinc-800">
                    <img src="jbarber/jjj.png" alt="JBarber" class="w-full h-full object-cover rounded-full">
                </div>
            </div>
            <h1 class="mt-6 text-5xl font-display text-gray-900 dark:text-white tracking-wide">JBARBER<span class="text-barberRed">.</span></h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 font-medium tracking-[0.2em] uppercase mt-1">Estilo & Precisión</p>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-6">
            <div class="space-y-1">
                <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider ml-1">Usuario</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </div>
                    <input type="text" id="usuario_login" required placeholder="Cédula o código" 
                        class="w-full pl-11 pr-4 py-4 bg-gray-50 dark:bg-zinc-800/50 border-b-2 border-gray-200 dark:border-zinc-700 rounded-t-xl focus:bg-white dark:focus:bg-zinc-800 focus:border-barberRed outline-none transition-all font-medium text-gray-900 dark:text-white placeholder-gray-400">
                </div>
            </div>

            <div class="space-y-1">
                <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider ml-1">Contraseña</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    </div>
                    <input type="password" id="password_login" required placeholder="••••••••" 
                        class="w-full pl-11 pr-4 py-4 bg-gray-50 dark:bg-zinc-800/50 border-b-2 border-gray-200 dark:border-zinc-700 rounded-t-xl focus:bg-white dark:focus:bg-zinc-800 focus:border-barberRed outline-none transition-all font-medium text-gray-900 dark:text-white placeholder-gray-400">
                </div>
            </div>

            <button type="submit" id="btnSubmit" class="w-full bg-gray-900 dark:bg-white text-white dark:text-black font-bold py-4 rounded-xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all duration-300 flex items-center justify-center gap-3 group">
                <span id="btnText">INICIAR SESIÓN</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
            </button>
        </form>

        <div class="mt-8 pt-6 border-t border-gray-100 dark:border-zinc-800 text-center">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">¿Eres nuevo en JBarber?</p>
            <button onclick="abrirModalRegistro()" class="text-barberRed font-bold hover:text-red-700 transition-colors text-sm tracking-wide border border-barberRed/20 px-6 py-2 rounded-full hover:bg-barberRed/5">
                CREAR CUENTA
            </button>
        </div>
    </div>
  </div>

  <button id="btn-install-pwa" class="hidden fixed bottom-6 right-6 z-50 bg-barberRed text-white px-4 py-3 rounded-full shadow-2xl hover:scale-105 transition-transform font-bold flex items-center gap-2 animate-bounce-in">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
    </svg>
    Instalar App
  </button>

  <div id="modalRegistro" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 px-4 transition-all duration-300">
    <div class="bg-white dark:bg-zinc-900 rounded-2xl w-full max-w-lg p-8 relative shadow-2xl border border-gray-200 dark:border-zinc-800 animate-modal max-h-[90vh] overflow-y-auto">
      <button onclick="cerrarModalRegistro()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 text-2xl">&times;</button>
      
      <h2 class="text-2xl font-bold mb-2 text-gray-900 dark:text-white">Crea tu perfil en segundos</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Guarda tus datos y evita filas innecesarias.</p>

      <form id="formRegistro" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1 dark:text-gray-300">Nombre Completo</label>
            <input type="text" id="reg_nombre" required class="w-full p-3 border rounded-xl bg-black/60 border-gray-700 text-white focus:border-blue-600 focus:ring-2 focus:ring-blue-500/40 outline-none transition-all duration-300">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 dark:text-gray-300">Teléfono</label>
            <input type="tel" id="reg_telefono" required pattern="[0-9]{8,15}" class="w-full p-3 border rounded-xl bg-black/60 border-gray-700 text-white focus:border-blue-600 focus:ring-2 focus:ring-blue-500/40 outline-none transition-all duration-300">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1 dark:text-gray-300">Correo Electrónico</label>
          <input type="email" id="reg_email" required class="w-full p-3 border rounded-xl bg-black/60 border-gray-700 text-white focus:border-blue-600 focus:ring-2 focus:ring-blue-500/40 outline-none transition-all duration-300">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1 dark:text-gray-300">Usuario (Cédula o Código 6 dígitos)</label>
          <input type="text" id="reg_documento" required class="w-full p-3 border rounded-xl bg-black/60 border-gray-700 text-white focus:border-blue-600 focus:ring-2 focus:ring-blue-500/40 outline-none transition-all duration-300" placeholder="Ej: 40212345678">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1 dark:text-gray-300">Contraseña</label>
          <input type="password" id="reg_password" required minlength="4" class="w-full p-3 border rounded-xl bg-black/60 border-gray-700 text-white focus:border-blue-600 focus:ring-2 focus:ring-blue-500/40 outline-none transition-all duration-300">
        </div>
        <button type="submit" id="btnRegSubmit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-blue-600/20">
          <span id="btnRegText">Crear Cuenta</span>
        </button>
      </form>
    </div>
  </div>

  <script type="module">
    import { supabase } from './database.js';
    const negocioId = 'barberia005';

    // Lógica PWA para Login
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    let deferredPrompt;
    const installBtn = document.getElementById('btn-install-pwa');
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.classList.remove('hidden');
    });

    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if(outcome === 'accepted') installBtn.classList.add('hidden');
        deferredPrompt = null;
      }
    });

    // Funciones Modal
    const modal = document.getElementById('modalRegistro');
    window.abrirModalRegistro = () => {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.animation = 'neonPulse 1.5s ease-in-out';
    };
    window.cerrarModalRegistro = () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.animation = '';
    };

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const usuario = document.getElementById('usuario_login').value.trim();
      const pass = document.getElementById('password_login').value.trim();
      const btn = document.getElementById('btnSubmit');
      const btnText = document.getElementById('btnText');

      btn.disabled = true;
      btn.classList.add('opacity-70', 'cursor-not-allowed');
      btnText.textContent = 'Verificando...';

      try {
        const { data, error } = await supabase
          .from('clientes')
          .select('*')
          .eq('negocio_id', negocioId)
          .eq('documento_identidad', usuario)
          .eq('password', pass) // Nota: En producción usar hash
          .maybeSingle();

        if (error) throw error;
        if (!data) throw new Error('Credenciales incorrectas');

        // Guardar sesión cliente
        localStorage.setItem(`cliente_id_${negocioId}`, data.id);
        localStorage.setItem(`cliente_nombre_${negocioId}`, data.nombre);
        localStorage.setItem(`cliente_telefono_${negocioId}`, data.telefono);
        localStorage.setItem(`cliente_avatar_${negocioId}`, data.avatar_url || '');

        // Redirigir al nuevo panel
        window.location.href = 'panel_cliente.html';

      } catch (error) {
        alert(error.message || 'Error al iniciar sesión');
        btn.disabled = false;
        btn.classList.remove('opacity-70', 'cursor-not-allowed');
        btnText.textContent = 'Ingresar';
      }
    });

    // Registro
    document.getElementById('formRegistro').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nombre = document.getElementById('reg_nombre').value.trim();
      const telefono = document.getElementById('reg_telefono').value.trim();
      const email = document.getElementById('reg_email').value.trim();
      const documento = document.getElementById('reg_documento').value.trim();
      const pass = document.getElementById('reg_password').value.trim();
      
      const btn = document.getElementById('btnRegSubmit');
      const btnText = document.getElementById('btnRegText');

      btn.disabled = true;
      btnText.textContent = 'Creando cuenta...';

      try {
        // 1. Verificar si ya existe el documento
        const { data: existente, error: errorCheck } = await supabase
          .from('clientes')
          .select('id')
          .eq('negocio_id', negocioId)
          .eq('documento_identidad', documento)
          .maybeSingle();

        if (errorCheck) throw errorCheck;
        if (existente) throw new Error('Este usuario/cédula ya está registrado');

        // 2. Insertar nuevo cliente
        const { data, error } = await supabase
          .from('clientes')
          .insert([{
            negocio_id: negocioId,
            nombre,
            telefono,
            email,
            documento_identidad: documento,
            password: pass // En producción: usar hashing
          }])
          .select()
          .single();

        if (error) throw error;

        alert('¡Cuenta creada con éxito! Ya puedes iniciar sesión.');
        cerrarModalRegistro();
        document.getElementById('usuario_login').value = documento;
        document.getElementById('password_login').value = pass;

      } catch (error) {
        alert(error.message || 'Error al registrarse');
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Crear Cuenta';
      }
    });

    const readyOverlay = document.getElementById('readyOverlay');
    if (readyOverlay) {
      readyOverlay.classList.remove('hidden');
      readyOverlay.classList.add('flex');
      setTimeout(() => {
        readyOverlay.classList.add('hidden');
        readyOverlay.classList.remove('flex');
      }, 2500);
    }
  </script>
  <div id="readyOverlay" class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm items-center justify-center p-6">
    <div class="w-full max-w-sm bg-white/10 border border-white/20 rounded-2xl p-8 text-center shadow-2xl">
      <img src="jbarber/jjj.png" alt="JBarber" class="w-16 h-16 rounded-lg mx-auto mb-4 shadow-lg shadow-red-500/30 object-cover">
      <h3 class="text-white font-extrabold text-2xl tracking-tight">Listo, ya puedes tomar turno</h3>
      <p class="text-white/80 text-sm mt-2">Bienvenido a JBarber.</p>
      <div class="mt-4 flex items-center justify-center gap-2 text-white/80">
        <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle>
          <path d="M4 12a8 8 0 018-8" stroke-width="4" class="opacity-75"></path>
        </svg>
        <span class="text-sm">Cargando…</span>
      </div>
    </div>
  </div>
</body>
</html>
